<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Study Tasks + Timers (v6.2-refactored)</title>
<style>
  /* THEME VARIABLES */
  :root{
    --bg:#0b1225;--card:#111827;--text:#e5e7eb;--muted:#9aa3b2;--accent:#22c55e;--danger:#ef4444;--border:rgba(148,163,184,.2);--overlay:rgba(2,6,23,.7);
    --h1:22px; --task:16px; --sub:14px;
  }
  /* Light theme */
  [data-theme="light"]{
    --bg:#f6f7fb; --card:#ffffff; --text:#0b1225; --muted:#5b6575; --accent:#16a34a; --danger:#dc2626; --border:rgba(15,23,42,.15); --overlay:rgba(15,23,42,.3);
  }
  /* Sepia theme */
  [data-theme="sepia"]{
    --bg:#f4ecd8; --card:#fbf6ea; --text:#3f2f1e; --muted:#7a6a59; --accent:#2f855a; --danger:#b91c1c; --border:rgba(63,47,30,.18); --overlay:rgba(63,47,30,.25);
  }

  html,body{height:100%}
  body{margin:0;background:linear-gradient(135deg,var(--bg),var(--card));color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1040px;margin:24px auto;padding:16px}
  .card{background:color-mix(in oklab, var(--card) 90%, transparent);border:1px solid var(--border);backdrop-filter: blur(6px);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
  .header{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  h1{margin:0;font-size:var(--h1)}
  .spacer{flex:1}
  .pill{font-size:12px;background:color-mix(in oklab, var(--muted) 15%, transparent);padding:4px 8px;border-radius:999px;border:1px solid var(--border);margin-left:8px;color:var(--text)}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input[type="text"], input[type="number"], input[type="datetime-local"], input[type="date"]{flex:1;min-width:200px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--bg);color:var(--text);outline:none}
  input[type="number"].mini-in, input[type="datetime-local"].mini-in{min-width:120px;padding:6px 8px;border-radius:8px}
  button, select{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:600;background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn-primary{background:var(--accent);color:white;border:0}
  .btn-danger{background:color-mix(in oklab, var(--danger) 12%, transparent);color:color-mix(in oklab, var(--danger) 75%, white);border:1px solid color-mix(in oklab, var(--danger) 35%, transparent)}
  .list{margin-top:14px}
  .item{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;background:color-mix(in oklab, var(--bg) 50%, transparent);border:1px solid color-mix(in oklab, var(--border) 80%, transparent);padding:10px 12px;border-radius:12px;margin:8px 0}
  .left{display:flex;gap:10px;align-items:center}
  .txt{word-break:break-word;padding:2px 4px;border-radius:6px;font-size:var(--task)}
  .txt.sub{font-size:var(--sub)}
  .txt[contenteditable="true"]{outline:2px solid color-mix(in oklab, var(--muted) 35%, transparent);background:var(--bg)}
  .done .txt{text-decoration:line-through;color:color-mix(in oklab, var(--muted) 70%, white)}
  .timer{font-family:ui-monospace,Menlo,monospace;background:color-mix(in oklab, var(--muted) 12%, transparent);padding:4px 8px;border-radius:10px}
  .controls button{margin-left:6px}
  #err{margin-top:8px;color:color-mix(in oklab, var(--danger) 85%, black);background:color-mix(in oklab, var(--danger) 12%, transparent);border:1px solid color-mix(in oklab, var(--danger) 30%, transparent);padding:8px 10px;border-radius:10px;display:none;font-size:12px;white-space:pre-wrap}
  .progress-wrap{display:flex;align-items:center;gap:10px;margin:8px 0}
  .progress{flex:1;height:10px;background:color-mix(in oklab, var(--muted) 18%, transparent);border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .progress>div{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#16a34a);transition:width .2s}
  .sep{height:1px;background:color-mix(in oklab, var(--muted) 18%, transparent);margin:12px 0}
  .mini{font-size:12px;color:var(--muted)}
  .goal-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .mini-bar{flex:1;min-width:140px;height:8px;background:color-mix(in oklab, var(--muted) 18%, transparent);border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .mini-bar>div{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#16a34a);transition:width .2s}
  .mini-bar.over>div{background:linear-gradient(90deg,var(--danger),#dc2626)}
  .overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
  .modal{max-width:760px;width:100%;background:color-mix(in oklab, var(--card) 95%, transparent);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);position:relative}
  .close-x{position:absolute;right:18px;top:14px;background:transparent;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:6px 10px;cursor:pointer}
  .clock{font:700 56px/1 ui-monospace,Menlo,monospace;text-align:center;margin:8px 0 16px}
  .focus-line{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:6px}
  .heat{display:grid;grid-template-columns:repeat(14,10px);gap:3px;align-items:center}
  .cell{width:10px;height:10px;border-radius:2px;background:color-mix(in oklab, var(--muted) 28%, transparent);border:1px solid color-mix(in oklab, var(--border) 80%, transparent)}
  .lvl1{background:#1f6f3b} .lvl2{background:#2ea44f} .lvl3{background:#22c55e} .lvl4{background:#86efac}
  /* Collapsible animation */
  .collapsible{transition:max-height .25s ease, opacity .2s ease, transform .2s ease; overflow:hidden;}
  .collapsible[aria-hidden="true"]{max-height:0;opacity:0;transform:translateY(-6px);pointer-events:none}
  .collapsible[aria-hidden="false"]{max-height:600px;opacity:1;transform:none}
  /* Simple/Compact modes */
  .simple #heatmap, .simple #archList, .simple .goal-row, .simple #toggleArchive, .simple #archiveBtn { display:none !important; }
  .compact .timer, .compact .controls { display:none !important; }
  /* Edge Best pill */
  #bestEdge{position:fixed;right:14px;bottom:14px;z-index:70}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h1>Study Tasks + Timers <span class="muted">(v6.2)</span></h1>
      <div class="spacer"></div>
      <span id="saveStatus" class="pill" title="Last saved">Saved ‚Äî</span>
      <span id="todayTop" class="pill">Today 00:00</span>
      <span id="bestTop" class="pill" title="All-time best single day">Best 00:00 on ‚Äî</span>
    </div>

    <div class="row" style="margin-top:8px">
      <input id="taskInput" type="text" placeholder="New task‚Ä¶ e.g., 40 Anki cards">
      <button class="btn-primary" id="addBtn" type="button">Add Task</button>
      <button class="btn" id="clearDoneBtn" type="button">Clear Completed</button>
      <button class="btn" id="archiveBtn" type="button">Archive Completed</button>
      <button class="btn" id="toggleArchive" type="button">Open Archive</button>
      <button class="btn" id="exportBtn" type="button">Export JSON</button>
      <label class="btn" for="importFile" style="cursor:pointer;">Import JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button class="btn" id="backupBtn" type="button" title="Save a backup snapshot to localStorage">Quick Backup</button>
      <button class="btn" id="restoreBtn" type="button" title="Restore last backup from localStorage">Restore Backup</button>
      <button class="btn btn-danger" id="resetLS" type="button" title="Clear local data (export first!)">Reset Storage</button>
    </div>

    <div class="row display-row" style="margin-top:8px">
      <label class="muted">Theme</label>
      <select id="themeSelect" class="btn">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="sepia">Sepia</option>
      </select>

      <label class="muted">Jingle</label>
      <select id="soundSelect" class="btn">
        <option value="ding">Ding</option>
        <option value="chime">Chime</option>
        <option value="pop">Pop</option>
        <option value="custom">Custom (uploaded)</option>
      </select>
      <input type="file" id="soundFile" accept="audio/*">
      <label class="muted">Volume</label>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:140px">
      <span id="volLabel" class="muted">100%</span>
      <label class="muted"><input id="playToggle" type="checkbox" checked> Play on complete</label>
      <label class="muted"><input id="beatToggle" type="checkbox" checked> Chime when I beat TTB</label>
      <label class="muted"><input id="barsToggle" type="checkbox" checked> Show TTB/Deadline bars</label>
      <label class="muted"><input id="simpleToggle" type="checkbox"> Simple</label>
      <label class="muted"><input id="compactToggle" type="checkbox"> Compact</label>
      <label class="muted">Header <input id="h1Size" type="range" min="18" max="32" value="22"></label>
      <label class="muted">Task <input id="taskSize" type="range" min="14" max="22" value="16"></label>
      <label class="muted">Subtask <input id="subSize" type="range" min="12" max="20" value="14"></label>
    </div>

    <div class="row" style="margin-top:8px">
      <span id="streak" class="pill">üî• Streak: 0</span>
      <div id="heatmap" class="heat" title="Daily minutes heatmap (last 14√ó7 days)"></div>
      <span id="totalTime" class="pill" style="margin-left:auto">Total 00:00:00</span>
    </div>

    <div class="progress-wrap">
      <div class="progress"><div id="progBar"></div></div>
      <span id="progText" class="muted">0% (0/0 done)</span>
    </div>

    <div id="list" class="list" aria-live="polite"></div>
    <div id="archList" class="list" style="display:none"></div>
    <div id="err"></div>
  </div>
</div>

<!-- Edge best pill -->
<div id="bestEdge" class="pill" title="All-time best single day">Best 00:00 on ‚Äî</div>

<!-- Focus Modal -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <button id="closeFocus" class="close-x">Close (Esc)</button>
    <h2 id="focusTitle">Focus</h2>
    <div class="clock" id="focusClock">00:00:00</div>
    <div class="focus-line" id="focusTTBLine"></div>
    <div class="focus-line" id="focusDeadLine"></div>
    <div class="row" style="justify-content:center">
      <button id="focusStart" class="btn-primary">Start</button>
      <button id="focusPause" class="btn">Pause</button>
      <button id="focusReset" class="btn btn-danger">Reset</button>
      <button id="focusDone" class="btn">Mark Done</button>
    </div>
    <div class="muted" style="text-align:center;margin-top:6px">Shortcuts: Space start/pause ‚Ä¢ R reset ‚Ä¢ Esc close</div>
  </div>
</div>

<script>
(function(){
  // ---------- Helpers ----------
  const on=(el,ev,fn)=>el.addEventListener(ev,fn);
  const $=id=>document.getElementById(id);
  const pad=n=>String(n).padStart(2,'0');
  const fmtHMS=ms=>{ms=Math.max(0,Math.floor(ms||0));const s=Math.floor(ms/1000);return pad(Math.floor(s/3600))+':'+pad(Math.floor((s%3600)/60))+':'+pad(s%60)};
  const fmtHM=ms=>{ms=Math.max(0,Math.floor(ms/60000));return pad(Math.floor(ms/60))+':'+pad(ms%60)};
  const newId=()=> 'id-'+Date.now()+'-'+Math.random().toString(36).slice(2,7);
  const safeSet=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));touchSaved()}catch{}};
  const safeGet=(k,fb)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):fb}catch{return fb}};
  const debounce=(fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
  const toLocalDatetimeInput=ts=>{if(!ts)return'';const d=new Date(ts),p=n=>String(n).padStart(2,'0');return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate())+'T'+p(d.getHours())+':'+p(d.getMinutes())};
  const fmtDelta=ms=>{ms=Math.floor(Math.abs(ms)/1000);const h=Math.floor(ms/3600),m=Math.floor((ms%3600)/60),s=ms%60;const p=[];if(h)p.push(h+'h');if(m||h)p.push(m+'m');p.push(s+'s');return p.join(' ')};

  // ---------- Storage keys ----------
  const LS_T='study_tasks_v62', LS_S='study_settings_v62', LS_A='study_archived_v62';
  const LS_BACKUP_LAST='study_backup_last_v62', LS_BACKUP_RING='study_backup_ring_v62';

  // ---------- State ----------
  let state={
    tasks:safeGet(LS_T,[]),
    archived:safeGet(LS_A,[]),
    settings:Object.assign({sound:'ding',custom:null,vol:1,play:true,beatChime:true,showBars:true,simple:false,compact:false,h1:22,task:16,sub:14,theme:'dark'}, safeGet(LS_S,{}))
  };

  // Theme early
  document.body.setAttribute('data-theme', state.settings.theme || 'dark');

  // ---------- Audio ----------
  let audioCtx=null; const getCtx=()=>{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; };
  function playJingle(){ if(!state.settings.play) return; const v=+state.settings.vol||1;
    if(state.settings.custom && ($('soundSelect').value==='custom')){const a=new Audio(state.settings.custom);a.volume=v;a.play().catch(()=>{});return}
    const ctx=getCtx(), now=ctx.currentTime;
    const beep=(f,d,vol,delay,type='sine')=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type=type;o.frequency.value=f;g.gain.setValueAtTime(0.0001,now+delay);g.gain.exponentialRampToValueAtTime(vol,now+delay+0.02);g.gain.exponentialRampToValueAtTime(0.0001,now+delay+d);o.connect(g).connect(ctx.destination);o.start(now+delay);o.stop(now+delay+d+0.02)};
    const m=$('soundSelect').value||'ding';
    if(m==='ding'){beep(880,0.10,v*0.7,0);beep(1175,0.12,v*0.6,0.12)}
    else if(m==='chime'){beep(659,0.25,v*0.8,0);beep(523,0.35,v*0.6,0.02);beep(784,0.40,v*0.5,0.03)}
    else {beep(300,0.09,v*0.4,0,'square')}
  }
  function playBeat(){ if(!state.settings.beatChime) return; const ctx=getCtx(), now=ctx.currentTime;
    const t=(f,d,vol,delay)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.0001,now+delay);g.gain.exponentialRampToValueAtTime(vol,now+delay+0.02);g.gain.exponentialRampToValueAtTime(0.0001,now+delay+d);o.connect(g).connect(ctx.destination);o.start(now+delay);o.stop(now+delay+d+0.02)};
    t(988,0.08,0.5,0); t(1319,0.10,0.5,0.10);
  }

  // ---------- UI refs ----------
  const listEl=$('list'), inputEl=$('taskInput'), addBtn=$('addBtn');
  const soundSel=$('soundSelect'), fileEl=$('soundFile'), volEl=$('vol'), volLabel=$('volLabel'), playChk=$('playToggle'), beatChk=$('beatToggle'), barsToggle=$('barsToggle');
  const exportBtn=$('exportBtn'), importFile=$('importFile'), resetLS=$('resetLS'), backupBtn=$('backupBtn'), restoreBtn=$('restoreBtn');
  const progBar=$('progBar'), progText=$('progText'), totalTime=$('totalTime'), todayTop=$('todayTop'), bestTop=$('bestTop'), bestEdge=$('bestEdge');
  const streakEl=$('streak'), heatEl=$('heatmap'), saveStatus=$('saveStatus');
  const overlay=$('overlay'), focusTitle=$('focusTitle'), focusClock=$('focusClock'), focusStart=$('focusStart'), focusPause=$('focusPause'), focusReset=$('focusReset'), focusDone=$('focusDone');
  const simpleToggle=$('simpleToggle'), compactToggle=$('compactToggle'), h1Size=$('h1Size'), taskSize=$('taskSize'), subSize=$('subSize'), themeSelect=$('themeSelect');

  // ---------- Save helpers ----------
  function touchSaved(){ saveStatus.textContent='Saved '+new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
  const saveSettings=()=>safeSet(LS_S,state.settings);
  const saveSettingsDebounced=debounce(saveSettings,120);
  const save=()=>safeSet(LS_T,state.tasks);
  const saveArchive=()=>safeSet(LS_A,state.archived);

  // ---------- Font vars ----------
  function applyFontVars(){
    document.documentElement.style.setProperty('--h1', state.settings.h1+'px');
    document.documentElement.style.setProperty('--task', state.settings.task+'px');
    document.documentElement.style.setProperty('--sub', state.settings.sub+'px');
  }

  // ---------- Init settings UI ----------
  themeSelect.value=state.settings.theme || 'dark';
  soundSel.value=state.settings.custom?'custom':(state.settings.sound||'ding');
  volEl.value=typeof state.settings.vol==='number'?state.settings.vol:1; volLabel.textContent=Math.round(+volEl.value*100)+'%';
  playChk.checked=!!state.settings.play; beatChk.checked=!!state.settings.beatChime; barsToggle.checked=!!state.settings.showBars;
  simpleToggle.checked=!!state.settings.simple; compactToggle.checked=!!state.settings.compact;
  if(state.settings.simple) document.body.classList.add('simple'); if(state.settings.compact) document.body.classList.add('compact');
  h1Size.value=state.settings.h1; taskSize.value=state.settings.task; subSize.value=state.settings.sub; applyFontVars(); touchSaved();

  on(themeSelect,'change',()=>{ state.settings.theme=themeSelect.value; document.body.setAttribute('data-theme', state.settings.theme); saveSettings(); });
  on(soundSel,'change',()=>{state.settings.sound=soundSel.value;saveSettings()});
  on(fileEl,'change',()=>{const f=fileEl.files[0];if(!f)return;const fr=new FileReader();fr.onload=()=>{state.settings.custom=fr.result;state.settings.sound='custom';soundSel.value='custom';saveSettings()};fr.readAsDataURL(f)});
  on(volEl,'input',()=>{state.settings.vol=+volEl.value;volLabel.textContent=Math.round(+volEl.value*100)+'%';saveSettingsDebounced()});
  on(playChk,'change',()=>{state.settings.play=!!playChk.checked;saveSettings()});
  on(beatChk,'change',()=>{state.settings.beatChime=!!beatChk.checked;saveSettings()});
  on(barsToggle,'change',()=>{state.settings.showBars=!!barsToggle.checked; saveSettings(); render();});
  on(simpleToggle,'change',()=>{state.settings.simple=simpleToggle.checked; document.body.classList.toggle('simple',state.settings.simple); saveSettings()});
  on(compactToggle,'change',()=>{state.settings.compact=compactToggle.checked; document.body.classList.toggle('compact',state.settings.compact); saveSettings()});
  on(h1Size,'input',()=>{state.settings.h1=+h1Size.value; applyFontVars(); saveSettingsDebounced()});
  on(taskSize,'input',()=>{state.settings.task=+taskSize.value; applyFontVars(); saveSettingsDebounced()});
  on(subSize,'input',()=>{state.settings.sub=+subSize.value; applyFontVars(); saveSettingsDebounced()});

  // ---------- Shapes ----------
  function ensureShapeTask(t){
    t.sessions=t.sessions||[]; t.ttb_ms=(typeof t.ttb_ms==='number' && t.ttb_ms>0)?t.ttb_ms:null;
    t.deadline_ts=t.deadline_ts||null; t.completed_at=t.completed_at||null;
    t.subtasks=(t.subtasks||[]).map(ensureShapeSub);
    t.order=(typeof t.order==='number')?t.order:(state.tasks?.length||0);
    t.collapsed=!!t.collapsed;
    return t;
  }
  function ensureShapeSub(s){
    s.id=s.id||newId(); s.text=s.text||'Subtask'; s.done=!!s.done;
    s.elapsed=s.elapsed||0; s.running=!!s.running; s.startedAt=s.startedAt||null;
    s.sessions=s.sessions||[]; s.ttb_ms=(typeof s.ttb_ms==='number' && s.ttb_ms>0)?s.ttb_ms:null;
    s.deadline_ts=s.deadline_ts||null; s.completed_at=s.completed_at||null; s.order=(typeof s.order==='number')?s.order:0;
    return s;
  }

  // ---------- Timers ----------
  function pauseTask(o){
    if(!o || !o.running) return;
    o.elapsed += Date.now() - (o.startedAt || Date.now());
    o.running = false;
    const last = o.sessions && o.sessions.length ? o.sessions[o.sessions.length-1] : null;
    if(last && last.end === null) last.end = Date.now();
    o.startedAt = null;
  }
  function pauseAllOthers(except){
    state.tasks.forEach(o=>{
      if(o !== except) pauseTask(o);
      (o.subtasks||[]).forEach(s=>{ if(s !== except) pauseTask(s); });
    });
  }
  function startRun(t){
    pauseAllOthers(t);
    if(t.running) return;
    t.running = true;
    t.startedAt = Date.now();
    t.sessions = t.sessions || [];
    t.sessions.push({ start: t.startedAt, end: null });
  }
  function currentMs(o){
    if(o && Array.isArray(o.subtasks) && o.subtasks.length>0){
      return o.subtasks.reduce((s,st)=> s + currentMs(st), 0);
    }
    return o && o.running ? (o.elapsed + (Date.now()-(o.startedAt||Date.now()))) : (o?.elapsed||0);
  }
  function resetTimerObject(o){
    const list = (o.subtasks && o.subtasks.length>0) ? o.subtasks : [o];
    list.forEach(x=>{ x.elapsed=0; x.sessions=[]; if(x.running) x.startedAt=Date.now(); });
  }

  // ---------- Errors ----------
  const showErr=msg=>{ const e=$('err'); e.style.display='block'; e.textContent=msg; };
  const hideErr=()=>{ const e=$('err'); e.style.display='none'; e.textContent=''; };

  // ---------- Add / Import / Export / Reset / Backups ----------
  function addTask(){
    try{
      const txt=(inputEl.value||'').trim(); if(!txt) return;
      const t=ensureShapeTask({ id:newId(), text:txt, done:false, elapsed:0, running:false, startedAt:null, order:state.tasks.length, created:new Date().toISOString(), sessions:[], ttb_ms:null, deadline_ts:null, completed_at:null, subtasks:[], collapsed:false });
      state.tasks.push(t); save(); render(); inputEl.value=''; inputEl.focus(); refreshAgg(true);
    }catch(ex){ showErr('Add failed: '+ex.message) }
  }
  on(addBtn,'click',addTask);
  on(inputEl,'keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addTask(); }});

  on($('clearDoneBtn'),'click',()=>{ state.tasks=state.tasks.filter(t=>!t.done); reindex(); save(); render(); refreshAgg(true); });
  on($('archiveBtn'),'click',()=>{ const moved=[]; state.tasks=state.tasks.filter(t=>{ if(t.done){ moved.push(t); return false } return true; }); if(moved.length){ state.archived=(state.archived||[]).concat(moved); save(); saveArchive(); render(); refreshAgg(true); }});
  on($('toggleArchive'),'click',()=>{ const el=$('archList'); if(el.style.display==='none'){ el.style.display='block'; el.innerHTML=''; (state.archived||[]).slice().reverse().forEach(t=>{ const r=document.createElement('div'); r.className='item done'; r.innerHTML = '<div class="txt">‚úì '+t.text+'</div><span class="timer">'+fmtHMS(currentMs(t))+'</span>'; el.appendChild(r); }); } else { el.style.display='none'; }});
  on(exportBtn,'click',()=>{ const data={version:'v6.2',exportedAt:new Date().toISOString(),tasks:state.tasks,archived:state.archived,settings:state.settings}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='study_tasks_backup.json'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove()},200)});
  on(importFile,'change',()=>{ const f=importFile.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const data=JSON.parse(fr.result);
        if(Array.isArray(data.tasks)) state.tasks=data.tasks.map(ensureShapeTask);
        if(Array.isArray(data.archived)) state.archived=data.archived.map(ensureShapeTask);
        if(data.settings) state.settings=Object.assign({},state.settings,data.settings);
        themeSelect.value=state.settings.theme||'dark'; document.body.setAttribute('data-theme', state.settings.theme||'dark');
        soundSel.value=state.settings.custom?'custom':(state.settings.sound||'ding');
        volEl.value=typeof state.settings.vol==='number'?state.settings.vol:1; volLabel.textContent=Math.round(+volEl.value*100)+'%';
        playChk.checked=!!state.settings.play; beatChk.checked=!!state.settings.beatChime; barsToggle.checked=!!state.settings.showBars;
        simpleToggle.checked=!!state.settings.simple; compactToggle.checked=!!state.settings.compact;
        document.body.classList.toggle('simple',state.settings.simple); document.body.classList.toggle('compact',state.settings.compact);
        h1Size.value=state.settings.h1; taskSize.value=state.settings.task; subSize.value=state.settings.sub; applyFontVars();
        save(); saveArchive(); saveSettings(); render(); refreshAgg(true);
      }catch(e){ showErr('Import failed: '+e.message) } }; fr.readAsText(f) });
  on(resetLS,'click',()=>{ if(confirm('This clears local data on this device. Export first if needed. Proceed?')){ localStorage.removeItem(LS_T); localStorage.removeItem(LS_A); localStorage.removeItem(LS_S); localStorage.removeItem(LS_BACKUP_LAST); localStorage.removeItem(LS_BACKUP_RING); location.reload(); }});

  function quickBackup(){
    try{
      const snap={ at:new Date().toISOString(), tasks:state.tasks, archived:state.archived, settings:state.settings };
      safeSet(LS_BACKUP_LAST, snap);
      const ring = safeGet(LS_BACKUP_RING, []);
      ring.push(snap); while(ring.length>5) ring.shift(); safeSet(LS_BACKUP_RING, ring);
      alert('Backup saved locally at '+snap.at);
    }catch(e){ showErr('Backup failed: '+e.message) }
  }
  function restoreBackup(){
    try{
      const last=safeGet(LS_BACKUP_LAST,null);
      if(!last){ alert('No backup found. Use Quick Backup first.'); return; }
      if(!confirm('Restore backup from '+last.at+'? This will overwrite current in-browser data.')) return;
      state.tasks=(last.tasks||[]).map(ensureShapeTask);
      state.archived=(last.archived||[]).map(ensureShapeTask);
      state.settings=Object.assign({}, state.settings, last.settings||{});
      document.body.setAttribute('data-theme', state.settings.theme||'dark');
      save(); saveArchive(); saveSettings(); render(); refreshAgg(true);
      alert('Restored backup from '+last.at);
    }catch(e){ showErr('Restore failed: '+e.message) }
  }
  on(backupBtn,'click',quickBackup);
  on(restoreBtn,'click',restoreBackup);
  setInterval(()=>{ quickBackup(); }, 5*60*1000); // auto-backup

  // ---------- Ordering ----------
  function reindex(){ state.tasks.forEach((t,i)=> t.order=i) }
  function swapOrder(arr, fromIdx, toIdx){
    if (toIdx<0 || toIdx>=arr.length) return;
    const a = arr.find(x=>x.order===fromIdx), b = arr.find(x=>x.order===toIdx);
    if (!a || !b) return;
    [a.order, b.order] = [b.order, a.order];
    arr.sort((x,y)=>x.order-y.order);
  }
  function moveItem(t,dir){ swapOrder(state.tasks, t.order, t.order+dir); save(); render(); }
  function moveSub(parent,s,dir){ swapOrder(parent.subtasks||[], s.order, s.order+dir); save(); render(); }

  // ---------- Progress + totals ----------
  function updateTimer(o){ const el=$('tm-'+o.id); if(el) el.textContent=fmtHMS(currentMs(o)); }
  function updateProgress(){
    const total=state.tasks.length||1; const done=state.tasks.filter(t=>t.done).length; const pct=Math.round(done/total*100);
    progBar.style.width=pct+'%'; progText.textContent=pct+'% ('+done+'/'+(state.tasks.length||0)+' done)';
    function* leaves(tasks){ for(const t of tasks){ if(t.subtasks && t.subtasks.length>0) { for(const s of t.subtasks) yield s; } else yield t; } }
    let totalMs=0; for(const leaf of leaves(state.tasks)) totalMs+=currentMs(leaf);
    totalTime.textContent='Total '+fmtHMS(totalMs);
  }

  // ---------- Heatmap / streak / best ----------
  function aggregateMinutesByDay(){
    const map={};
    function addSpan(a,b){ if(!isFinite(a)||!isFinite(b)||b<=a) return; let start=a; while(start<b){ const dayEnd=new Date(start); dayEnd.setHours(23,59,59,999); const end=Math.min(b,dayEnd.getTime()); const key=new Date(start).toISOString().slice(0,10); map[key]=(map[key]||0)+(end-start); start=end+1; } }
    const all=[];
    state.tasks.forEach(t=>{ if(t.subtasks && t.subtasks.length>0){ t.subtasks.forEach(s=> all.push(s)); } else { all.push(t); }});
    state.archived.forEach(t=>{ if(t.subtasks && t.subtasks.length>0){ t.subtasks.forEach(s=> all.push(s)); } else { all.push(t); }});
    all.forEach(o=>{ (o.sessions||[]).forEach(s=>{ const a=s.start, b=s.end||Date.now(); addSpan(a,b); }); });
    Object.keys(map).forEach(k=> map[k]=Math.round(map[k]/60000));
    return map;
  }
  function drawHeatmapStreakBest(){
    const minutesByDay=aggregateMinutesByDay();
    const today=new Date(); today.setHours(0,0,0,0); const todayKey=today.toISOString().slice(0,10);
    const todayMin=minutesByDay[todayKey]||0; todayTop.textContent='Today '+fmtHM(todayMin*60000);
    heatEl.innerHTML='';
    for(let col=97; col>=0; col--){ const dayTs=today.getTime()-col*86400000; const key = new Date(dayTs).toISOString().slice(0,10); const mins=minutesByDay[key]||0;
      let lvl=''; if(mins===0) lvl=''; else if(mins>=120) lvl='lvl4'; else if(mins>=60) lvl='lvl3'; else if(mins>=30) lvl='lvl2'; else lvl='lvl1';
      const cell=document.createElement('div'); cell.className='cell '+lvl; cell.title=key+': '+mins+' min'; heatEl.appendChild(cell); }
    let streak=0; for(let i=0;i<500;i++){ const key=new Date(today.getTime()-i*86400000).toISOString().slice(0,10); const mins=minutesByDay[key]||0; if(mins>0) streak++; else break; }
    streakEl.textContent='üî• Streak: '+streak;
    let best=0,bestDate='‚Äî'; Object.keys(minutesByDay).forEach(k=>{ if(minutesByDay[k]>best){best=minutesByDay[k]; bestDate=k} });
    const bestTxt='Best '+fmtHM(best*60000)+' on '+(bestDate==='‚Äî'?'‚Äî':bestDate);
    bestTop.textContent=bestTxt; bestEdge.textContent=bestTxt;
  }
  let lastAgg=0; function refreshAgg(force=false){ const now=Date.now(); if(force || now-lastAgg>60000){ drawHeatmapStreakBest(); lastAgg=now; } }

  // ---------- Unified goals updater ----------
  function updateGoals(o){
    const ms=currentMs(o);
    const ttbEl=$('ttb-'+o.id), barEl=$('bar-'+o.id), dlEl=$('dl-'+o.id);
    if(ttbEl && barEl){
      if(o.ttb_ms){
        const rem=o.ttb_ms-ms; const pct=Math.max(0,Math.min(100,Math.round(ms/o.ttb_ms*100)));
        if(barEl.firstChild) barEl.firstChild.style.width=pct+'%';
        ttbEl.textContent='TTB: '+Math.round(o.ttb_ms/60000)+'m ‚Ä¢ ' + (rem>=0 ? ('remaining '+fmtHMS(rem)) : ('over by '+fmtHMS(-rem)));
        barEl.classList.toggle('over', rem<0);
        barEl.style.display = state.settings.showBars ? '' : 'none';
      } else {
        ttbEl.textContent='TTB: ‚Äî'; if(barEl.firstChild) barEl.firstChild.style.width='0%'; barEl.classList.remove('over');
      }
    }
    if(dlEl){
      if(o.deadline_ts){
        const diff=o.deadline_ts-Date.now(); const d=new Date(o.deadline_ts); const timeStr=d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        dlEl.textContent = (diff>=0? ('Deadline: ‚è≥ '+fmtDelta(diff)+' left ') : ('Deadline: ‚è∞ past by '+fmtDelta(-diff)+' ')) + '('+timeStr+')';
        dlEl.style.color = diff<0 ? 'color-mix(in oklab, var(--danger) 85%, black)' : '';
      } else { dlEl.textContent='Deadline: ‚Äî'; dlEl.style.color=''; }
    }
  }

  // ---------- Editable helper ----------
  function makeEditable(el, get, set){
    function start(){ el.setAttribute('contenteditable','true'); el.focus();
      const r=document.createRange(); r.selectNodeContents(el); r.collapse(false);
      const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
    }
    function stop(commit){
      if (el.getAttribute('contenteditable')!=='true') return;
      el.removeAttribute('contenteditable');
      if (commit){
        const v=el.textContent.trim();
        if (v) set(v); else el.textContent=get();
        save();
      } else el.textContent=get();
    }
    on(el,'click',start);
    on(el,'keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); stop(true); } if(e.key==='Escape'){ e.preventDefault(); stop(false); }});
    on(el,'blur',()=>stop(true));
  }

  // ---------- Rows ----------
  function row(t){
    ensureShapeTask(t);
    const r=document.createElement('div'); r.className='item'+(t.done?' done':'');
    const left=document.createElement('div'); left.className='left';

    const caret=document.createElement('button'); caret.className='btn'; caret.textContent=t.collapsed?'‚ñ∏':'‚ñæ'; caret.title='Collapse/expand';
    on(caret,'click',()=>{ 
      t.collapsed=!t.collapsed; caret.textContent=t.collapsed?'‚ñ∏':'‚ñæ';
      const g = r.querySelector('.goals.collapsible'); const subs = r.querySelector('.subwrap.collapsible');
      if(g) g.setAttribute('aria-hidden', t.collapsed?'true':'false');
      if(subs) subs.setAttribute('aria-hidden', t.collapsed?'true':'false');
      save();
    });

    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=t.done;
    on(cb,'change',()=>{ 
      if(cb.checked){ (t.subtasks||[]).forEach(st=>pauseTask(st)); if(!t.subtasks?.length) pauseTask(t);
        t.done=true; t.collapsed=true; t.completed_at=new Date().toISOString();
        if(t.ttb_ms && currentMs(t)<=t.ttb_ms) { playBeat(); } playJingle(); if('vibrate' in navigator) navigator.vibrate(20);
      } else { t.done=false; t.completed_at=null; }
      save(); render(); refreshAgg(true);
    });

    const txt=document.createElement('div'); txt.className='txt'; txt.textContent=t.text; txt.title='Click to edit';
    makeEditable(txt, ()=>t.text, v=>{ t.text=v; });

    left.appendChild(caret); left.appendChild(cb); left.appendChild(txt);

    const timer=document.createElement('span'); timer.className='timer'; timer.id='tm-'+t.id; timer.textContent=fmtHMS(currentMs(t));

    const ctr=document.createElement('div'); ctr.className='controls';
    const hasSubs = (t.subtasks && t.subtasks.length>0);

    if(!hasSubs){
      const start=document.createElement('button'); start.className='btn'; start.textContent=t.running?'Pause':'Start';
      on(start,'click',()=>{ if(t.running) pauseTask(t); else startRun(t); timer.textContent=fmtHMS(currentMs(t)); start.textContent=t.running?'Pause':'Start'; save(); updateGoals(t); refreshAgg(true); });
      const reset=document.createElement('button'); reset.className='btn'; reset.textContent='Reset';
      on(reset,'click',()=>{ if(confirm('Reset timer and clear session history for this task?')){ resetTimerObject(t); timer.textContent=fmtHMS(currentMs(t)); save(); updateGoals(t); }});
      ctr.appendChild(start); ctr.appendChild(reset);
    }else{
      const info=document.createElement('span'); info.className='muted'; info.textContent='Timer = sum of subtasks';
      ctr.appendChild(info);
    }

    const up=document.createElement('button'); up.className='btn'; up.textContent='‚Üë'; on(up,'click',()=> moveItem(t,-1));
    const down=document.createElement('button'); down.className='btn'; down.textContent='‚Üì'; on(down,'click',()=> moveItem(t,1));
    const focusBtn=document.createElement('button'); focusBtn.className='btn-primary'; focusBtn.textContent='Focus'; on(focusBtn,'click',()=> openFocus({obj:t, isSub:false}) );
    const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='Delete';
    on(del,'click',()=>{ if(confirm('Delete this task?')){ if(!hasSubs && t.running) pauseTask(t); (t.subtasks||[]).forEach(s=>pauseTask(s)); state.tasks=state.tasks.filter(x=>x.id!==t.id); reindex(); save(); render(); refreshAgg(true); }});
    ctr.appendChild(up); ctr.appendChild(down); ctr.appendChild(focusBtn); ctr.appendChild(del);

    // Goals + editors
    const goals=document.createElement('div'); goals.className='goals collapsible'; goals.style.gridColumn='1/-1';
    goals.setAttribute('aria-hidden', t.collapsed ? 'true':'false');
    const gl=document.createElement('div'); gl.className='goal-row';

    const ttbTxt=document.createElement('span'); ttbTxt.className='mini'; ttbTxt.id='ttb-'+t.id; ttbTxt.textContent='TTB: ‚Äî';
    const ttbBar=document.createElement('div'); ttbBar.className='mini-bar'; const ttbFill=document.createElement('div'); ttbBar.appendChild(ttbFill); ttbBar.id='bar-'+t.id; if(!state.settings.showBars) ttbBar.style.display='none';
    const ttbIn=document.createElement('input'); ttbIn.type='number'; ttbIn.className='mini-in'; ttbIn.placeholder='TTB min'; ttbIn.value = t.ttb_ms ? Math.round(t.ttb_ms/60000) : '';
    const setTTB=document.createElement('button'); setTTB.className='btn'; setTTB.textContent='Set TTB';
    on(setTTB,'click',()=>{ const mins=parseInt(ttbIn.value,10); t.ttb_ms = (isFinite(mins)&&mins>0) ? mins*60000 : null; save(); updateGoals(t); if(focusRef?.obj?.id===t.id) updateFocusLines(); });

    const dlTxt=document.createElement('span'); dlTxt.className='mini'; dlTxt.id='dl-'+t.id; dlTxt.textContent='Deadline: ‚Äî';
    const dlIn=document.createElement('input'); dlIn.type='datetime-local'; dlIn.className='mini-in'; dlIn.value = t.deadline_ts ? toLocalDatetimeInput(t.deadline_ts) : '';
    const setDL=document.createElement('button'); setDL.className='btn'; setDL.textContent='Set';
    on(setDL,'click',()=>{ t.deadline_ts = dlIn.value ? new Date(dlIn.value).getTime() : null; save(); updateGoals(t); if(focusRef?.obj?.id===t.id) updateFocusLines(); });

    gl.appendChild(ttbTxt); gl.appendChild(ttbBar); gl.appendChild(ttbIn); gl.appendChild(setTTB);
    gl.appendChild(dlTxt); gl.appendChild(dlIn); gl.appendChild(setDL);
    goals.appendChild(gl);

    // Subtasks
    const subWrap=document.createElement('div'); subWrap.className='subwrap collapsible'; subWrap.setAttribute('aria-hidden', t.collapsed?'true':'false'); subWrap.style.gridColumn='1/-1';
    const subHead=document.createElement('div'); subHead.className='row'; subHead.style.marginTop='6px';
    const subInput=document.createElement('input'); subInput.type='text'; subInput.placeholder='Add subtask‚Ä¶';
    const subAdd=document.createElement('button'); subAdd.className='btn'; subAdd.textContent='Add Subtask';
    on(subAdd,'click',()=>{ const v=(subInput.value||'').trim(); if(!v) return; const s=ensureShapeSub({id:newId(),text:v,done:false,elapsed:0,running:false,startedAt:null,sessions:[],ttb_ms:null,deadline_ts:null,order:(t.subtasks||[]).length});
      t.subtasks=t.subtasks||[]; t.subtasks.push(s); save(); render(); subInput.value=''; refreshAgg(true);
    });
    on(subInput,'keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); subAdd.click(); }});
    const hideDone=document.createElement('label'); hideDone.className='muted'; hideDone.innerHTML=`<input type="checkbox" ${t.hideDoneSubs?'checked':''}> Hide done`;
    on(hideDone.firstChild,'change',e=>{ t.hideDoneSubs=!!e.target.checked; save(); render(); });

    subHead.appendChild(subInput); subHead.appendChild(subAdd); subHead.appendChild(hideDone);
    const subList=document.createElement('div');
    const showSubs=(t.hideDoneSubs?(t.subtasks||[]).filter(s=>!s.done):(t.subtasks||[])).slice().sort((a,b)=>(a.order-b.order));
    showSubs.forEach((s)=> subList.appendChild(subRow(t,s)));

    subWrap.appendChild(subHead); subWrap.appendChild(subList);

    r.appendChild(left); r.appendChild(timer); r.appendChild(ctr); r.appendChild(goals); r.appendChild(subWrap);
    updateGoals(t);
    return r;
  }

  function subRow(parent,s){
    const r=document.createElement('div'); r.className='item'+(s.done?' done':'');
    const left=document.createElement('div'); left.className='left';
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=s.done;
    on(cb,'change',()=>{ 
      if(cb.checked){ if(s.running) pauseTask(s); s.done=true; s.completed_at=new Date().toISOString(); if(s.ttb_ms && currentMs(s)<=s.ttb_ms) { playBeat(); } playJingle(); if('vibrate' in navigator) navigator.vibrate(20);
      } else { s.done=false; s.completed_at=null; }
      save(); render(); refreshAgg(true);
    });
    const txt=document.createElement('div'); txt.className='txt sub'; txt.textContent=s.text; txt.title='Click to edit';
    makeEditable(txt, ()=>s.text, v=>{ s.text=v; });

    left.appendChild(cb); left.appendChild(txt);

    const timer=document.createElement('span'); timer.className='timer'; timer.id='tm-'+s.id; timer.textContent=fmtHMS(currentMs(s));

    const ctr=document.createElement('div'); ctr.className='controls';
    const start=document.createElement('button'); start.className='btn'; start.textContent=s.running?'Pause':'Start';
    on(start,'click',()=>{ if(s.running) pauseTask(s); else startRun(s); timer.textContent=fmtHMS(currentMs(s)); start.textContent=s.running?'Pause':'Start'; save(); updateGoals(s); refreshAgg(true); });
    const reset=document.createElement('button'); reset.className='btn'; reset.textContent='Reset';
    on(reset,'click',()=>{ if(confirm('Reset timer and clear session history for this subtask?')){ resetTimerObject(s); timer.textContent=fmtHMS(currentMs(s)); save(); updateGoals(s); }});
    const up=document.createElement('button'); up.className='btn'; up.textContent='‚Üë'; on(up,'click',()=> moveSub(parent,s,-1));
    const down=document.createElement('button'); down.className='btn'; down.textContent='‚Üì'; on(down,'click',()=> moveSub(parent,s,1));
    const focusBtn=document.createElement('button'); focusBtn.className='btn-primary'; focusBtn.textContent='Focus'; on(focusBtn,'click',()=> openFocus({obj:s, isSub:true, parent}) );
    const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='Delete';
    on(del,'click',()=>{ if(confirm('Delete this subtask?')){ if(s.running) pauseTask(s); parent.subtasks=(parent.subtasks||[]).filter(x=>x.id!==s.id); parent.subtasks.forEach((x,i)=>x.order=i); save(); render(); refreshAgg(true); }});
    ctr.appendChild(start); ctr.appendChild(reset); ctr.appendChild(up); ctr.appendChild(down); ctr.appendChild(focusBtn); ctr.appendChild(del);

    // Sub-goals inline
    const goals=document.createElement('div'); goals.className='goals'; goals.style.gridColumn='1/-1';
    const gl=document.createElement('div'); gl.className='goal-row';
    const ttbTxt=document.createElement('span'); ttbTxt.className='mini'; ttbTxt.id='ttb-'+s.id; ttbTxt.textContent='TTB: ‚Äî';
    const ttbBar=document.createElement('div'); ttbBar.className='mini-bar'; const ttbFill=document.createElement('div'); ttbBar.appendChild(ttbFill); ttbBar.id='bar-'+s.id; if(!state.settings.showBars) ttbBar.style.display='none';
    const ttbIn=document.createElement('input'); ttbIn.type='number'; ttbIn.className='mini-in'; ttbIn.placeholder='TTB min'; ttbIn.value = s.ttb_ms ? Math.round(s.ttb_ms/60000) : '';
    const setTTB=document.createElement('button'); setTTB.className='btn'; setTTB.textContent='Set TTB';
    on(setTTB,'click',()=>{ const mins=parseInt(ttbIn.value,10); s.ttb_ms = (isFinite(mins)&&mins>0) ? mins*60000 : null; save(); updateGoals(s); if(focusRef?.obj?.id===s.id) updateFocusLines(); });

    const dlTxt=document.createElement('span'); dlTxt.className='mini'; dlTxt.id='dl-'+s.id; dlTxt.textContent='Deadline: ‚Äî';
    const dlIn=document.createElement('input'); dlIn.type='datetime-local'; dlIn.className='mini-in'; dlIn.value = s.deadline_ts ? toLocalDatetimeInput(s.deadline_ts) : '';
    const setDL=document.createElement('button'); setDL.className='btn'; setDL.textContent='Set';
    on(setDL,'click',()=>{ s.deadline_ts = dlIn.value ? new Date(dlIn.value).getTime() : null; save(); updateGoals(s); if(focusRef?.obj?.id===s.id) updateFocusLines(); });

    gl.appendChild(ttbTxt); gl.appendChild(ttbBar); gl.appendChild(ttbIn); gl.appendChild(setTTB);
    gl.appendChild(dlTxt); gl.appendChild(dlIn); gl.appendChild(setDL);
    goals.appendChild(gl);

    r.appendChild(left); r.appendChild(timer); r.appendChild(ctr); r.appendChild(goals);
    updateGoals(s);
    return r;
  }

  // ---------- Render ----------
  function render(){
    hideErr();
    listEl.innerHTML='';
    if(state.tasks.length===0){const d=document.createElement('div');d.className='muted';d.textContent='No tasks yet ‚Äî add one above.';listEl.appendChild(d)}
    state.tasks.slice().sort((a,b)=>(a.order-b.order)||(a.created>b.created?1:-1)).forEach((t)=>listEl.appendChild(row(t)));
    updateProgress();
    refreshAgg(false);
  }

  // ---------- Focus overlay ----------
  let focusRef=null;
  function openFocus(ref){ focusRef=ref; const o=ref.obj; overlay.style.display='flex'; $('focusTitle').textContent='Focus: '+o.text; updateFocusClock(); updateFocusLines(); }
  function updateFocusLines(){
    if(!focusRef) return; const o=focusRef.obj;
    const ttbLine=$('focusTTBLine'); ttbLine.innerHTML='';
    if(o.ttb_ms){ const rem=o.ttb_ms - currentMs(o); const pill = document.createElement('span'); pill.className='pill'; pill.textContent = rem>=0 ? ('TTB remaining '+fmtHMS(rem)) : ('TTB over by '+fmtHMS(-rem)); ttbLine.appendChild(pill); }
    const deadLine=$('focusDeadLine'); deadLine.innerHTML='';
    if(o.deadline_ts){ const diff=o.deadline_ts - Date.now(); const pill = document.createElement('span'); pill.className='pill'; pill.textContent = diff>=0 ? ('Deadline '+fmtDelta(diff)+' left') : ('Deadline past by '+fmtDelta(-diff)); if(diff<0) pill.style.borderColor='var(--danger)'; deadLine.appendChild(pill); }
  }
  function updateFocusClock(){ if(!focusRef) return; focusClock.textContent = fmtHMS(currentMs(focusRef.obj)); }

  on($('closeFocus'),'click',()=>{ overlay.style.display='none'; focusRef=null; });
  on(focusStart,'click',()=>{ if(!focusRef) return; const o=focusRef.obj;
    if(o.subtasks && o.subtasks.length>0){ const next=o.subtasks.find(s=>!s.done) || o.subtasks[0]; startRun(next); }
    else startRun(o);
    save(); updateFocusLines(); refreshAgg(true); 
  });
  on(focusPause,'click',()=>{ if(!focusRef) return; const o=focusRef.obj; if(o.subtasks && o.subtasks.length>0){ o.subtasks.forEach(s=>pauseTask(s)); } else pauseTask(o); save(); updateFocusLines(); });
  on(focusReset,'click',()=>{ if(!focusRef) return; const o=focusRef.obj; if(confirm('Reset timer and clear session history?')){ resetTimerObject(o); save(); updateFocusLines(); }});
  on(focusDone,'click',()=>{ if(!focusRef) return; const o=focusRef.obj; o.done=true; if(o.subtasks && o.subtasks.length>0){ o.subtasks.forEach(s=>pauseTask(s)); } else pauseTask(o);
    if(o.ttb_ms && currentMs(o)<=o.ttb_ms) playBeat(); playJingle(); o.completed_at=new Date().toISOString(); save(); render(); refreshAgg(true); });

  on(document,'keydown',e=>{
    if(overlay.style.display==='flex'){
      if(e.key==='Escape'){ overlay.style.display='none'; focusRef=null; }
      else if(e.key===' '){ e.preventDefault(); if(!focusRef) return; const o=focusRef.obj;
        if(o.subtasks && o.subtasks.length>0){ const anyRunning=o.subtasks.some(s=>s.running); if(anyRunning){ o.subtasks.forEach(s=>pauseTask(s)); } else { const next=o.subtasks.find(s=>!s.done) || o.subtasks[0]; startRun(next); } }
        else{ o.running?pauseTask(o):startRun(o); }
        save(); updateFocusLines(); refreshAgg(true); 
      }
      else if(e.key.toLowerCase()==='r'){ e.preventDefault(); if(!focusRef) return; resetTimerObject(focusRef.obj); save(); updateFocusLines(); }
    }
  });

  // ---------- Tick ----------
  setInterval(()=>{ 
    state.tasks.forEach(t=>{ updateTimer(t); updateGoals(t); (t.subtasks||[]).forEach(s=>{ if(s.running) updateTimer(s); updateGoals(s); }); });
    updateProgress();
    refreshAgg(false);
    if(focusRef) { updateFocusClock(); updateFocusLines(); }
  },1000);

  // ---------- Boot ----------
  state.tasks = (state.tasks||[]).map(ensureShapeTask);
  state.archived = (state.archived||[]).map(ensureShapeTask);
  render();
  inputEl.focus();
})();
</script>
</body>
</html>
