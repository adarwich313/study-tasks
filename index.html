<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Study Tasks + Timers (v6.0 â€¢ Subtasks + Collapse + Best Day + Fix Pause)</title>
<style>
  :root{--bg:#0b1225;--card:#111827;--text:#e5e7eb;--muted:#9aa3b2;--accent:#22c55e;--danger:#ef4444;--border:rgba(148,163,184,.2);--overlay:rgba(2,6,23,.7);--h1size:22px;--tasksize:16px;--subsize:15px}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(135deg,#0b1225,#121a33);color:#e5e7eb;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1040px;margin:24px auto;padding:16px}
  .card{background:rgba(17,24,39,.84);border:1px solid var(--border);backdrop-filter: blur(6px);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .header{display:flex;align-items:center;gap:10px}
  h1{margin:0;font-size:var(--h1size)}
  .spacer{flex:1}
  .pill{font-size:12px;background:rgba(148,163,184,.15);padding:4px 8px;border-radius:999px;border:1px solid var(--border);margin-left:8px}
  .muted{color:var(--muted);font-size:12px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input[type="text"], input[type="number"], input[type="datetime-local"], input[type="date"]{flex:1;min-width:200px;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0b1225;color:#e5e7eb;outline:none}
  button{cursor:pointer;border:0;border-radius:12px;padding:10px 14px;font-weight:600}
  .btn{background:transparent;border:1px solid var(--border);color:#e5e7eb}
  .btn-primary{background:var(--accent);color:#052e16;border:0}
  .btn-danger{background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
  .list{margin-top:14px}
  .item{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;background:rgba(2,6,23,.5);border:1px solid rgba(148,163,184,.12);padding:10px 12px;border-radius:12px;margin:8px 0}
  .left{display:flex;gap:10px;align-items:center}
  .txt{word-break:break-word;padding:2px 4px;border-radius:6px;font-size:var(--tasksize)}
  .txt[contenteditable="true"]{outline:2px solid rgba(148,163,184,.35);background:#0b1225}
  .done .txt{text-decoration:line-through;color:#9ca3af}
  .timer{font-family:ui-monospace,Menlo,monospace;background:rgba(148,163,184,.12);padding:4px 8px;border-radius:10px}
  .controls button{margin-left:6px}
  #err{margin-top:8px;color:#fecaca;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);padding:8px 10px;border-radius:10px;display:none;font-size:12px;white-space:pre-wrap}
  .progress-wrap{display:flex;align-items:center;gap:10px;margin:8px 0}
  .progress{flex:1;height:10px;background:rgba(148,163,184,.18);border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .progress>div{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#16a34a);transition:width .2s}
  .mini{font-size:12px;color:#9aa3b2}
  .goal-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .mini-bar{flex:1;min-width:140px;height:8px;background:rgba(148,163,184,.18);border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .mini-bar>div{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#16a34a);transition:width .2s}
  .mini-bar.over>div{background:linear-gradient(90deg,#ef4444,#dc2626)}
  .overlay{position:fixed;inset:0;background:var(--overlay);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
  .modal{max-width:760px;width:100%;background:rgba(17,24,39,.95);border:1px solid var(--border);border-radius:18px;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.5);position:relative}
  .close-x{position:absolute;right:18px;top:14px;background:transparent;border:1px solid var(--border);color:#e5e7eb;border-radius:10px;padding:6px 10px;cursor:pointer}
  .clock{font:700 56px/1 ui-monospace,Menlo,monospace;text-align:center;margin:8px 0 16px}
  .focus-line{display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin-bottom:6px}
  .heat{display:grid;grid-template-columns:repeat(14,10px);gap:3px;align-items:center}
  .cell{width:10px;height:10px;border-radius:2px;background:#1f2937;border:1px solid rgba(148,163,184,.12)}
  .lvl1{background:#1f6f3b} .lvl2{background:#2ea44f} .lvl3{background:#22c55e} .lvl4{background:#86efac}
  .subwrap{grid-column:1/-1;margin-left:36px;margin-top:6px;border-left:2px dashed rgba(148,163,184,.25);padding-left:12px}
  .subwrap .txt{font-size:var(--subsize)}
  .tiny{font-size:11px;padding:4px 6px;border-radius:8px;border:1px solid var(--border);background:transparent;color:#e5e7eb}
  .edge{position:fixed;right:16px;bottom:16px;z-index:80}
  .caret{width:26px;height:26px;border-radius:8px;border:1px solid var(--border);background:transparent;color:#e5e7eb;display:inline-flex;align-items:center;justify-content:center;font-weight:700}
  .display-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
  .range{accent-color:#22c55e}
  /* Smooth collapse animation */
  .collapsible{transition:max-height .25s ease, opacity .2s ease, transform .2s ease;overflow:hidden}
  .collapsible[aria-hidden="true"]{max-height:0;opacity:0;transform:translateY(-6px);pointer-events:none}
  .collapsible[aria-hidden="false"]{max-height:700px;opacity:1;transform:none}
  /* Simple & Compact modes */
  .simple #heatmap,.simple #archList,.simple .goal-row,.simple .display-row input[type="number"],.simple .display-row input[type="datetime-local"],.simple #toggleArchive,.simple #archiveBtn{display:none!important}
  .compact .timer,.compact .controls{display:none!important}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h1>Study Tasks + Timers <span class="muted">(v6.0)</span></h1>
      <div class="spacer"></div>
      <span id="todayTop" class="pill">Today 00:00</span>
      <span id="bestDay" class="pill" title="Best single-day total">Best â€”</span>
    </div>

    <div class="row" style="margin-top:8px">
      <input id="taskInput" type="text" placeholder="New taskâ€¦ e.g., Pathoma Chapter 1">
      <button class="btn-primary" id="addBtn" type="button">Add Task</button>
      <button class="btn" id="clearDoneBtn" type="button">Clear Completed</button>
      <button class="btn" id="archiveBtn" type="button">Archive Completed</button>
      <button class="btn" id="toggleArchive" type="button">Open Archive</button>
      <button class="btn" id="exportBtn" type="button">Export JSON</button>
      <label class="btn" for="importFile" style="cursor:pointer;">Import JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button class="btn btn-danger" id="resetStorage" type="button" title="Clears saved data if it became corrupt">Reset Storage</button>
    </div>

    <div class="row" style="margin-top:8px">
      <label class="muted">Jingle</label>
      <select id="soundSelect" class="btn">
        <option value="ding">Ding</option>
        <option value="chime">Chime</option>
        <option value="pop">Pop</option>
        <option value="custom">Custom (uploaded)</option>
      </select>
      <input type="file" id="soundFile" accept="audio/*">
      <label class="muted">Volume</label>
      <input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:140px">
      <span id="volLabel" class="muted">100%</span>
      <label class="muted"><input id="playToggle" type="checkbox" checked> Play on complete</label>
      <label class="muted"><input id="beatToggle" type="checkbox" checked> Chime when I beat TTB</label>
      <label class="muted"><input id="ttbToggle" type="checkbox" checked> Show TTB/Deadline bars</label>
      <button id="testBtn" class="btn" type="button">Test Jingle</button>
    </div>

    <div class="row" style="margin-top:4px">
      <span class="muted">Display</span>
      <div class="display-row">
        <label class="muted">Header</label>
        <input id="h1Size" class="range" type="range" min="18" max="34" step="1" value="22">
        <label class="muted">Task</label>
        <input id="taskSize" class="range" type="range" min="14" max="20" step="1" value="16">
        <label class="muted">Subtask</label>
        <input id="subSize" class="range" type="range" min="12" max="18" step="1" value="15">
        <label class="muted"><input id="simpleToggle" type="checkbox"> Simple UI</label>
        <label class="muted"><input id="compactToggle" type="checkbox"> Compact</label>
        <button id="collapseAll" class="btn" type="button">Collapse All</button>
        <button id="expandAll" class="btn" type="button">Expand All</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <span id="streak" class="pill">ðŸ”¥ Streak: 0</span>
      <div id="heatmap" class="heat" title="Daily minutes heatmap (last 14Ã—7 days)"></div>
      <span id="totalTime" class="pill" style="margin-left:auto">Total 00:00:00</span>
    </div>

    <div class="progress-wrap">
      <div class="progress"><div id="progBar"></div></div>
      <span id="progText" class="muted">0% (0/0 done)</span>
    </div>

    <div id="list" class="list" aria-live="polite"></div>
    <div id="archList" class="list" style="display:none"></div>
    <div id="bestFloat" class="pill edge" title="Best single-day total">Best â€”</div>
    <div id="err"></div>
  </div>
</div>

<!-- Focus Modal -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <button id="closeFocus" class="close-x">Close (Esc)</button>
    <h2 id="focusTitle">Focus</h2>
    <div class="clock" id="focusClock">00:00:00</div>
    <div class="focus-line" id="focusTTBLine"></div>
    <div class="focus-line" id="focusDeadLine"></div>
    <div class="row" style="justify-content:center">
      <button id="focusStart" class="btn-primary">Start</button>
      <button id="focusPause" class="btn">Pause</button>
      <button id="focusReset" class="btn btn-danger">Reset</button>
      <button id="focusDone" class="btn">Mark Done</button>
    </div>
    <div class="muted" style="text-align:center;margin-top:6px">Shortcuts: Space start/pause â€¢ R reset â€¢ Esc close</div>
  </div>
</div>

<script>
(function(){
  const on=(el,ev,fn)=>el.addEventListener(ev,fn);
  const $=id=>document.getElementById(id);
  const pad=n=>String(n).padStart(2,'0');
  const fmtHMS=ms=>{ms=Math.max(0,Math.floor(ms||0));const s=Math.floor(ms/1000);return pad(Math.floor(s/3600))+':'+pad(Math.floor((s%3600)/60))+':'+pad(s%60)};
  const fmtHM=ms=>{ms=Math.max(0,Math.floor(ms/60000));return pad(Math.floor(ms/60))+':'+pad(ms%60)};
  const newId=()=> 'id-'+Date.now()+'-'+Math.random().toString(36).slice(2,7);
  const safeSet=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
  const safeGet=(k,fb)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):fb}catch{return fb}};

  const LS_T='study_tasks_v60', LS_S='study_settings_v60', LS_A='study_archived_v60', LS_B='study_best_v60';

  function showErr(msg){ const e=$('err'); e.style.display='block'; e.textContent=String(msg); }
  function clearErr(){ const e=$('err'); e.style.display='none'; e.textContent=''; }

  let state={
    tasks:safeGet(LS_T,[]),
    archived:safeGet(LS_A,[]),
    settings:Object.assign({sound:'ding',custom:null,vol:1,play:true,beatChime:true,showTTB:true,h1Size:22,taskSize:16,subSize:15,simple:false,compact:false}, safeGet(LS_S,{})),
    best: safeGet(LS_B,{minutes:0,date:null})
  };

  const listEl=$('list'), inputEl=$('taskInput'), addBtn=$('addBtn');
  const soundSel=$('soundSelect'), fileEl=$('soundFile'), volEl=$('vol'), volLabel=$('volLabel'), playChk=$('playToggle'), beatChk=$('beatToggle'), testBtn=$('testBtn');
  const exportBtn=$('exportBtn'), importFile=$('importFile');
  const progBar=$('progBar'), progText=$('progText'), totalTime=$('totalTime'), todayTop=$('todayTop');
  const streakEl=$('streak'), heatEl=$('heatmap'), bestDay=$('bestDay'), bestFloat=$('bestFloat');
  const overlay=$('overlay'), focusTitle=$('focusTitle'), focusClock=$('focusClock'), focusStart=$('focusStart'), focusPause=$('focusPause'), focusReset=$('focusReset'), focusDone=$('focusDone');
  const ttbToggle=$('ttbToggle');
  const h1Size=$('h1Size'), taskSize=$('taskSize'), subSize=$('subSize');
  const collapseAllBtn=$('collapseAll'), expandAllBtn=$('expandAll');
  const simpleToggle=$('simpleToggle'), compactToggle=$('compactToggle');

  function saveSettings(){ try{ safeSet(LS_S,state.settings) }catch(e){ showErr('Settings save failed: '+(e?.message||e)); } }
  function save(){ try{ safeSet(LS_T,state.tasks) }catch(e){ showErr('Save failed: '+(e?.message||e)); } }
  function saveArchive(){ try{ safeSet(LS_A,state.archived) }catch(e){ showErr('Archive save failed: '+(e?.message||e)); } }
  function saveBest(){ try{ safeSet(LS_B,state.best) }catch(e){ showErr('Best save failed: '+(e?.message||e)); } }

  function ensureShapeTask(t){
    if(!t || typeof t!=='object') return;
    if(t.sessions===undefined) t.sessions=[];
    if(t.ttb_ms===undefined) t.ttb_ms=null;
    if(t.deadline_ts===undefined) t.deadline_ts=null;
    if(t.completed_at===undefined) t.completed_at=null;
    if(typeof t.collapsed!=='boolean') t.collapsed=false;
    if(!Array.isArray(t.subtasks)) t.subtasks=[];
    t.subtasks.forEach(ensureShapeTask);
  }

  (state.tasks||[]).forEach(ensureShapeTask);
  (state.archived||[]).forEach(ensureShapeTask);

  soundSel.value=state.settings.custom?'custom':(state.settings.sound||'ding');
  volEl.value=typeof state.settings.vol==='number'?state.settings.vol:1; volLabel.textContent=Math.round(+volEl.value*100)+'%';
  playChk.checked=!!state.settings.play; beatChk.checked=!!state.settings.beatChime; ttbToggle.checked=!!state.settings.showTTB;

  // font vars
  function applyFontVars(){
    document.documentElement.style.setProperty('--h1size', (state.settings.h1Size||22)+'px');
    document.documentElement.style.setProperty('--tasksize', (state.settings.taskSize||16)+'px');
    document.documentElement.style.setProperty('--subsize', (state.settings.subSize||15)+'px');
  }
  h1Size.value=state.settings.h1Size; taskSize.value=state.settings.taskSize; subSize.value=state.settings.subSize; applyFontVars();

  // toggles
  simpleToggle.checked = !!state.settings.simple; document.body.classList.toggle('simple', !!state.settings.simple);
  compactToggle.checked = !!state.settings.compact; document.body.classList.toggle('compact', !!state.settings.compact);

  on(soundSel,'change',()=>{state.settings.sound=soundSel.value;saveSettings()});
  on(fileEl,'change',()=>{const f=fileEl.files[0];if(!f)return;const fr=new FileReader();fr.onload=()=>{state.settings.custom=fr.result;state.settings.sound='custom';soundSel.value='custom';saveSettings()};fr.readAsDataURL(f)});
  on(volEl,'input',()=>{state.settings.vol=+volEl.value;volLabel.textContent=Math.round(+volEl.value*100)+'%';saveSettings()});
  on(playChk,'change',()=>{state.settings.play=!!playChk.checked;saveSettings()});
  on(beatChk,'change',()=>{state.settings.beatChime=!!beatChk.checked;saveSettings()});
  on(ttbToggle,'change',()=>{state.settings.showTTB=!!ttbToggle.checked;saveSettings(); render();});
  on(h1Size,'input',()=>{state.settings.h1Size=+h1Size.value; applyFontVars(); saveSettings();});
  on(taskSize,'input',()=>{state.settings.taskSize=+taskSize.value; applyFontVars(); saveSettings();});
  on(subSize,'input',()=>{state.settings.subSize=+subSize.value; applyFontVars(); saveSettings();});
  on(simpleToggle,'change',()=>{ state.settings.simple = simpleToggle.checked; document.body.classList.toggle('simple', state.settings.simple); saveSettings(); });
  on(compactToggle,'change',()=>{ state.settings.compact = compactToggle.checked; document.body.classList.toggle('compact', state.settings.compact); saveSettings(); });
  on($('resetStorage'),'click',()=>{ if(confirm('This will clear all saved tasks, settings, and archives on this device. Proceed?')){ try{ localStorage.removeItem(LS_T); localStorage.removeItem(LS_A); localStorage.removeItem(LS_S); localStorage.removeItem(LS_B); state.tasks=[]; state.archived=[]; state.best={minutes:0,date:null}; state.settings={sound:'ding',custom:null,vol:1,play:true,beatChime:true,showTTB:true,h1Size:22,taskSize:16,subSize:15,simple:false,compact:false}; render(); }catch(err){ showErr('Reset failed: '+(err?.message||err)); } } });

  // audio
  function playJingle(){ if(!state.settings.play) return; const v=typeof state.settings.vol==='number'?state.settings.vol:1;
    if(state.settings.custom&&soundSel.value==='custom'){const a=new Audio(state.settings.custom);a.volume=v;a.play().catch(()=>{});return}
    const ctx=new (window.AudioContext||window.webkitAudioContext)(); const now=ctx.currentTime;
    const beep=(f,d,vol,delay,type='sine')=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type=type;o.frequency.value=f;g.gain.setValueAtTime(0.0001,now+delay);g.gain.exponentialRampToValueAtTime(vol,now+delay+0.02);g.gain.exponentialRampToValueAtTime(0.0001,now+delay+d);o.connect(g).connect(ctx.destination);o.start(now+delay);o.stop(now+delay+d+0.02)};
    const m=soundSel.value||'ding'; if(m==='ding'){beep(880,0.10,v*0.7,0);beep(1175,0.12,v*0.6,0.12)} else if(m==='chime'){beep(659,0.25,v*0.8,0);beep(523,0.35,v*0.6,0.02);beep(784,0.40,v*0.5,0.03)} else {beep(300,0.09,v*0.4,0,'square')}
  }
  function playBeat(){ if(!state.settings.beatChime) return; const ctx=new (window.AudioContext||window.webkitAudioContext)(); const now=ctx.currentTime;
    const t=(f,d,vol,delay)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.0001,now+delay);g.gain.exponentialRampToValueAtTime(vol,now+delay+0.02);g.gain.exponentialRampToValueAtTime(0.0001,now+delay+d);o.connect(g).connect(ctx.destination);o.start(now+delay);o.stop(now+delay+d+0.02)}; t(988,0.08,0.5,0); t(1319,0.10,0.5,0.10);
  }

  const currentMs = t => t && t.running ? t.elapsed + (Date.now()-(t.startedAt||Date.now())) : (t?t.elapsed:0);
  const fmtDelta=ms=>{ms=Math.floor(Math.abs(ms)/1000);const h=Math.floor(ms/3600),m=Math.floor((ms%3600)/60),s=ms%60;const p=[];if(h)p.push(h+'h');if(m||h)p.push(m+'m');p.push(s+'s');return p.join(' ')}

  // Pause helpers (fixed)
  function pauseTask(o){
    if(!o || !o.running) return;
    o.elapsed += Date.now() - (o.startedAt || Date.now());
    o.running = false;
    const last = o.sessions && o.sessions.length ? o.sessions[o.sessions.length-1] : null;
    if(last && last.end === null) last.end = Date.now();
    o.startedAt = null;
  }
  function pauseAllOthers(except){
    state.tasks.forEach(o=>{
      if(o !== except) pauseTask(o);
      (o.subtasks||[]).forEach(s=>{ if(s !== except) pauseTask(s); });
    });
  }
  function startRun(t){
    pauseAllOthers(t);
    if(t.running) return;
    t.running=true; t.startedAt=Date.now(); t.sessions=t.sessions||[]; t.sessions.push({start:t.startedAt,end:null});
  }

  function render(){ try{
    clearErr();
    listEl.innerHTML='';
    if(!Array.isArray(state.tasks)) state.tasks=[];
    if(state.tasks.length===0){const d=document.createElement('div');d.className='muted';d.textContent='No tasks yet â€” add one above.';listEl.appendChild(d)}
    state.tasks.slice().sort((a,b)=>(a.order-b.order)||(a.created>b.created?1:-1)).forEach((t,i)=>listEl.appendChild(row(t,i)));
    updateProgress(); drawHeatmapStreakBest();
  }catch(err){ showErr('Render error: '+(err?.message||err)); console.error(err); }}

  function row(t,idx,opts={isSub:false,parent:null}){
    ensureShapeTask(t);
    const r=document.createElement('div'); r.className='item'+(t.done?' done':'');

    const left=document.createElement('div'); left.className='left';
    const caret=document.createElement('button'); caret.className='caret'; caret.title='Collapse/expand (Alt+click: start & focus)'; caret.textContent = t.collapsed ? 'â–¸' : 'â–¾';
    on(caret,'click',(e)=>{
      if(e.altKey){ startRun(t); openFocus(t,opts); save(); return; }
      t.collapsed=!t.collapsed; caret.textContent=t.collapsed?'â–¸':'â–¾';
      const g = r.querySelector('.collapsible.goals');
      const subs = r.querySelector('.subwrap.collapsible');
      if(g) g.setAttribute('aria-hidden', t.collapsed?'true':'false');
      if(subs) subs.setAttribute('aria-hidden', t.collapsed?'true':'false');
      save();
    });

    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=t.done;
    on(cb,'change',()=>{ 
      if(cb.checked){ if(t.running) pauseTask(t); t.done=true; t.collapsed=true; t.completed_at=new Date().toISOString(); if(t.ttb_ms && currentMs(t)<=t.ttb_ms) playBeat(); playJingle(); if('vibrate' in navigator) navigator.vibrate(20); }
      else { t.done=false; t.completed_at=null; }
      save(); render();
    });

    const txt=document.createElement('div'); txt.className='txt'; txt.textContent=t.text; txt.title='Click to edit';
    function startEdit(){ txt.setAttribute('contenteditable','true'); txt.focus(); const range=document.createRange(); range.selectNodeContents(txt); range.collapse(false); const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range); }
    function stopEdit(saveIt){ if(txt.getAttribute('contenteditable')!=='true') return; txt.removeAttribute('contenteditable'); if(saveIt){ const v=txt.textContent.trim(); if(v){ t.text=v; save(); } else { txt.textContent=t.text; } } else { txt.textContent=t.text; } }
    on(txt,'click',()=>startEdit());
    on(txt,'keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); stopEdit(true); } if(e.key==='Escape'){ e.preventDefault(); stopEdit(false); } });
    on(txt,'blur',()=>stopEdit(true));

    left.appendChild(caret);
    left.appendChild(cb); left.appendChild(txt);

    const timer=document.createElement('span'); timer.className='timer'; timer.id='tm-'+t.id; timer.textContent=fmtHMS(currentMs(t));

    const ctr=document.createElement('div'); ctr.className='controls';
    const start=document.createElement('button'); start.className='btn'; start.textContent=t.running?'Pause':'Start';
    on(start,'click',()=>{ if(t.running) pauseTask(t); else startRun(t); timer.textContent=fmtHMS(currentMs(t)); start.textContent=t.running?'Pause':'Start'; save(); });
    const reset=document.createElement('button'); reset.className='btn'; reset.textContent='Reset';
    on(reset,'click',()=>{ if(confirm('Reset timer and clear session history for this '+(opts.isSub?'subtask?':'task?'))){ t.elapsed=0; t.sessions=[]; if(t.running) t.startedAt=Date.now(); timer.textContent=fmtHMS(currentMs(t)); save(); render(); } });
    const up=document.createElement('button'); up.className='btn'; up.textContent='â†‘'; on(up,'click',()=> move(idx,Math.max(0,idx-1),opts));
    const down=document.createElement('button'); down.className='btn'; down.textContent='â†“'; on(down,'click',()=> move(idx,Math.min((opts.isSub?(opts.parent.subtasks.length-1):(state.tasks.length-1)),idx+1),opts));
    const focusBtn=document.createElement('button'); focusBtn.className='btn-primary'; focusBtn.textContent='Focus'; on(focusBtn,'click',()=> openFocus(t,opts));
    const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='Delete';
    on(del,'click',()=>{ if(confirm('Delete this '+(opts.isSub?'subtask':'task')+'?')){ if(t.running) pauseTask(t); if(opts.isSub){ opts.parent.subtasks = opts.parent.subtasks.filter(x=>x.id!==t.id); } else { state.tasks=state.tasks.filter(x=>x.id!==t.id); reindex(); } save(); render(); }});

    ctr.appendChild(start); ctr.appendChild(reset); ctr.appendChild(up); ctr.appendChild(down); ctr.appendChild(focusBtn); ctr.appendChild(del);

    // Goals (always mounted, collapsible)
    const goals=document.createElement('div'); goals.style.gridColumn='1/-1'; goals.className='collapsible goals'; goals.setAttribute('aria-hidden', t.collapsed?'true':'false');
    if(state.settings.showTTB){
      const gl=document.createElement('div'); gl.className='goal-row';
      const ttbTxt=document.createElement('span'); ttbTxt.className='mini'; ttbTxt.id='ttb-'+t.id; ttbTxt.textContent='TTB: â€”';
      const ttbBar=document.createElement('div'); ttbBar.className='mini-bar'; const ttbFill=document.createElement('div'); ttbBar.appendChild(ttbFill); ttbBar.id='bar-'+t.id;
      const dlTxt=document.createElement('span'); dlTxt.className='mini'; dlTxt.id='dl-'+t.id; dlTxt.textContent='Deadline: â€”';
      gl.appendChild(ttbTxt); gl.appendChild(ttbBar); gl.appendChild(dlTxt);

      const quick=document.createElement('div'); quick.className='display-row';
      const ttbInput=document.createElement('input'); ttbInput.type='number'; ttbInput.placeholder='TTB min'; ttbInput.style.width='100px'; ttbInput.value = t.ttb_ms? Math.round(t.ttb_ms/60000):'';
      const setTTB=document.createElement('button'); setTTB.className='tiny'; setTTB.textContent='Set TTB'; on(setTTB,'click',()=>{ const mins=+ttbInput.value||0; t.ttb_ms = mins>0 ? mins*60000 : null; save(); updateGoalDisplays(t); if(focusRef?.obj?.id===t.id) updateFocusLines(); });
      const dlInput=document.createElement('input'); dlInput.type='datetime-local'; dlInput.style.width='190px'; dlInput.value = t.deadline_ts? new Date(t.deadline_ts).toISOString().slice(0,16):'';
      const setDL=document.createElement('button'); setDL.className='tiny'; setDL.textContent='Set Deadline'; on(setDL,'click',()=>{ const v=dlInput.value; t.deadline_ts = v? new Date(v).getTime(): null; save(); updateGoalDisplays(t); if(focusRef?.obj?.id===t.id) updateFocusLines(); });
      quick.appendChild(ttbInput); quick.appendChild(setTTB); quick.appendChild(dlInput); quick.appendChild(setDL);

      goals.appendChild(gl); goals.appendChild(quick);
    }

    r.appendChild(left); r.appendChild(timer); r.appendChild(ctr); r.appendChild(goals);
    updateGoalDisplays(t);

    // Subtasks (always mounted, collapsible when parent collapsed)
    if(!opts.isSub){
      const subWrap=document.createElement('div'); subWrap.className='subwrap collapsible';
      subWrap.setAttribute('aria-hidden', t.collapsed?'true':'false');
      const subHead=document.createElement('div'); subHead.className='display-row';
      const subTitle=document.createElement('span'); subTitle.className='mini'; subTitle.textContent='Subtasks';
      const hideDone = document.createElement('label'); hideDone.className='muted'; hideDone.innerHTML = `<input type="checkbox" ${t.hideDoneSubs?'checked':''}> Hide done`;
      hideDone.firstChild.addEventListener('change', e=>{ t.hideDoneSubs = e.target.checked; save(); render(); });
      const inp=document.createElement('input'); inp.type='text'; inp.placeholder='Add subtaskâ€¦ e.g., 1.1 Overview'; inp.style.flex='2';
      const addSub=document.createElement('button'); addSub.className='tiny'; addSub.textContent='Add';
      on(addSub,'click',()=>{ const v=(inp.value||'').trim(); if(!v) return; const st = makeTask(v, t.subtasks.length); t.subtasks.push(st); save(); render(); inp.value=''; });
      on(inp,'keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addSub.click(); }});
      subHead.appendChild(subTitle); subHead.appendChild(hideDone); subHead.appendChild(inp); subHead.appendChild(addSub);

      const subList=document.createElement('div');
      const showSubs = (t.hideDoneSubs) ? (t.subtasks||[]).filter(s=>!s.done) : (t.subtasks||[]);
      showSubs.slice().sort((a,b)=>(a.order-b.order)||(a.created>b.created?1:-1)).forEach((s,i)=>{
        subList.appendChild(row(s,i,{isSub:true,parent:t}));
      });
      subWrap.appendChild(subHead); subWrap.appendChild(subList);
      r.appendChild(subWrap);
    }
    return r;
  }

  function updateGoalDisplays(t){
    const ms=currentMs(t);
    const ttbEl=$('ttb-'+t.id), barEl=$('bar-'+t.id), dlEl=$('dl-'+t.id);
    if(ttbEl && barEl){
      if(t.ttb_ms){
        const rem=t.ttb_ms-ms; const pct=Math.max(0,Math.min(100,Math.round(ms/t.ttb_ms*100))); barEl.firstChild.style.width=pct+'%';
        if(rem>=0){ ttbEl.textContent='TTB: '+Math.round(t.ttb_ms/60000)+'m â€¢ remaining '+fmtHMS(rem); barEl.classList.remove('over'); }
        else { ttbEl.textContent='TTB: '+Math.round(t.ttb_ms/60000)+'m â€¢ over by '+fmtHMS(-rem); barEl.classList.add('over'); }
      } else { ttbEl.textContent='TTB: â€”'; barEl.firstChild.style.width='0%'; barEl.classList.remove('over'); }
    }
    if(dlEl){
      if(t.deadline_ts){
        const diff=t.deadline_ts-Date.now(); const d=new Date(t.deadline_ts); const timeStr=d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        if(diff>=0){ dlEl.textContent='Deadline: â³ '+fmtDelta(diff)+' left ('+timeStr+')'; dlEl.style.color=''; }
        else { dlEl.textContent='Deadline: â° past by '+fmtDelta(-diff)+' ('+timeStr+')'; dlEl.style.color='#fecaca'; }
      } else { dlEl.textContent='Deadline: â€”'; dlEl.style.color=''; }
    }
  }

  function move(from,to,opts){ if(from===to) return; if(opts?.isSub){ const arr=opts.parent.subtasks.slice().sort((a,b)=>(a.order-b.order)||(a.created>b.created?1:-1)); const item=arr.splice(from,1)[0]; arr.splice(to,0,item); arr.forEach((t,i)=> t.order=i); opts.parent.subtasks=arr; } else { const arr=state.tasks.slice().sort((a,b)=>(a.order-b.order)||(a.created>b.created?1:-1)); const item=arr.splice(from,1)[0]; arr.splice(to,0,item); arr.forEach((t,i)=> t.order=i); state.tasks=arr; }
    save(); render(); }
  function reindex(){ state.tasks.forEach((t,i)=>{t.order=i; (t.subtasks||[]).forEach((s,j)=> s.order=j);}) }

  function updateTimer(t){ const el=$('tm-'+t.id); if(el) el.textContent=fmtHMS(currentMs(t)); }

  function updateProgress(){
    const all=[...state.tasks, ...state.tasks.flatMap(t=>t.subtasks||[])];
    const total=all.length||1; const done=all.filter(t=>t.done).length; const pct=Math.round(done/total*100);
    $('progBar').style.width=pct+'%'; $('progText').textContent=pct+'% ('+done+'/'+(all.length||0)+' done)';
    const totalMs=all.reduce((s,t)=> s+currentMs(t),0); $('totalTime').textContent='Total '+fmtHMS(totalMs);
  }

  function makeTask(text,order){
    return { id:newId(), text, done:false, elapsed:0, running:false, startedAt:null, order:order||0, created:new Date().toISOString(), sessions:[], ttb_ms:null, deadline_ts:null, completed_at:null, subtasks:[], collapsed:false };
  }

  function aggregateMinutesByDay(){
    const map={};
    function addSpan(a,b){ if(!isFinite(a)||!isFinite(b)||b<=a) return; let start=a; while(start<b){ const dayEnd=new Date(start); dayEnd.setHours(23,59,59,999); const end=Math.min(b,dayEnd.getTime()); const key=new Date(start).toISOString().slice(0,10); map[key]=(map[key]||0)+(end-start); start=end+1; } }
    function collect(arr){ (arr||[]).forEach(t=>{ (t.sessions||[]).forEach(s=>{ const a=s.start, b=s.end||Date.now(); addSpan(a,b); }); collect(t.subtasks||[]); }); }
    collect(state.tasks); collect(state.archived);
    Object.keys(map).forEach(k=> map[k]=Math.round(map[k]/60000));
    return map;
  }
  function drawHeatmapStreakBest(){
    const minutesByDay=aggregateMinutesByDay();
    const today=new Date(); today.setHours(0,0,0,0); const todayKey=today.toISOString().slice(0,10);
    const todayMin=minutesByDay[todayKey]||0; $('todayTop').textContent='Today '+fmtHM(todayMin*60000);
    heatEl.innerHTML=''; for(let col=97; col>=0; col--){ const dayTs=today.getTime()-col*86400000; const key = new Date(dayTs).toISOString().slice(0,10); const mins=minutesByDay[key]||0;
      let lvl=''; if(mins===0) lvl=''; else if(mins>=120) lvl='lvl4'; else if(mins>=60) lvl='lvl3'; else if(mins>=30) lvl='lvl2'; else lvl='lvl1';
      const cell=document.createElement('div'); cell.className='cell '+lvl; cell.title=key+': '+mins+' min'; heatEl.appendChild(cell); }
    let streak=0; for(let i=0;i<500;i++){ const key=new Date(today.getTime()-i*86400000).toISOString().slice(0,10); const mins=minutesByDay[key]||0; const hit = mins>0; if(hit) streak++; else break; }
    $('streak').textContent='ðŸ”¥ Streak: '+streak;

    let bestM=0, bestDate=null; Object.entries(minutesByDay).forEach(([k,v])=>{ if(v>bestM){bestM=v; bestDate=k;} });
    if(bestM > (state.best.minutes||0)){ state.best={minutes:bestM,date:bestDate}; saveBest(); }
    if(state.best.minutes>0){ const txt='Best '+fmtHM(state.best.minutes*60000)+' on '+state.best.date; bestDay.textContent = txt; bestFloat.textContent = txt; } else { bestDay.textContent='Best â€”'; bestFloat.textContent='Best â€”'; }
  }

  // Focus overlay
  let focusRef=null; 
  function openFocus(obj,opts){
    focusRef = {obj, label: (opts?.isSub? 'Subtask: ':'Task: ')+obj.text};
    overlay.style.display='flex';
    $('focusTitle').textContent='Focus â€¢ '+focusRef.label;
    updateFocusClock();
  }
  function updateFocusLines(){
    const obj = focusRef?.obj; if(!obj) return;
    const ttbLine=$('focusTTBLine'); ttbLine.innerHTML='';
    if(obj.ttb_ms){ const rem = obj.ttb_ms - currentMs(obj); const pill=document.createElement('span'); pill.className='pill'; pill.textContent = rem>=0 ? ('TTB remaining '+fmtHMS(rem)) : ('TTB over by '+fmtHMS(-rem)); ttbLine.appendChild(pill); }
    const deadLine=$('focusDeadLine'); deadLine.innerHTML='';
    if(obj.deadline_ts){ const diff = obj.deadline_ts - Date.now(); const pill=document.createElement('span'); pill.className='pill'; pill.textContent = diff>=0 ? ('Deadline '+fmtDelta(diff)+' left') : ('Deadline past by '+fmtDelta(-diff)); if(diff<0) pill.style.borderColor='#ef4444'; deadLine.appendChild(pill); }
  }
  function updateFocusClock(){ if(!focusRef) return; $('focusClock').textContent = fmtHMS(currentMs(focusRef.obj)); updateFocusLines(); }
  on($('closeFocus'),'click',()=>{ overlay.style.display='none'; focusRef=null; });
  on(focusStart,'click',()=>{ if(!focusRef) return; startRun(focusRef.obj); save(); });
  on(focusPause,'click',()=>{ if(!focusRef) return; pauseTask(focusRef.obj); save(); });
  on(focusReset,'click',()=>{ if(!focusRef) return; if(confirm('Reset timer and clear session history?')){ focusRef.obj.elapsed=0; focusRef.obj.sessions=[]; if(focusRef.obj.running) focusRef.obj.startedAt=Date.now(); save(); }});
  on(focusDone,'click',()=>{ if(!focusRef) return; const o=focusRef.obj; o.done=true; pauseTask(o); if(o.ttb_ms && currentMs(o)<=o.ttb_ms) playBeat(); playJingle(); if('vibrate' in navigator) navigator.vibrate(20); o.completed_at=new Date().toISOString(); save(); render(); });

  on(document,'keydown',e=>{
    if(overlay.style.display==='flex'){
      if(e.key==='Escape'){ overlay.style.display='none'; focusRef=null; }
      else if(e.key===' '){ e.preventDefault(); if(!focusRef) return; focusRef.obj.running?pauseTask(focusRef.obj):startRun(focusRef.obj); save(); }
      else if(e.key.toLowerCase()==='r'){ e.preventDefault(); if(!focusRef) return; focusRef.obj.elapsed=0; focusRef.obj.sessions=[]; if(focusRef.obj.running) focusRef.obj.startedAt=Date.now(); save(); }
    }
  });

  function addTask(){
    try{
      const txt=(inputEl.value||'').trim(); if(!txt) return;
      const t=makeTask(txt, state.tasks && state.tasks.length ? state.tasks.length : 0);
      ensureShapeTask(t);
      state.tasks = Array.isArray(state.tasks)? state.tasks : [];
      state.tasks.push(t); save(); render(); inputEl.value=''; inputEl.focus();
    }catch(err){ showErr('Could not add task: '+(err?.message||err)); console.error(err); }
  }
  on(addBtn,'click',addTask);
  on(inputEl,'keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addTask(); } if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); addTask(); }});
  on($('clearDoneBtn'),'click',()=>{ state.tasks.forEach(t=> t.subtasks = (t.subtasks||[]).filter(s=>!s.done)); state.tasks=state.tasks.filter(t=>!t.done); reindex(); save(); render(); });

  on($('archiveBtn'),'click',()=>{ const moved=[]; const remain=[]; state.tasks.forEach(t=>{ const tcopy={...t, subtasks:(t.subtasks||[]).filter(s=>s.done)}; const tremain={...t, subtasks:(t.subtasks||[]).filter(s=>!s.done)}; if(t.done || tcopy.subtasks.length){ if(t.done) moved.push({...t, subtasks:(t.subtasks||[]) }); else moved.push(tcopy); }
    if(!t.done){ remain.push(tremain); } }); state.tasks=remain; if(moved.length){ state.archived=(state.archived||[]).concat(moved); save(); saveArchive(); render(); }});

  on($('toggleArchive'),'click',()=>{ const el=$('archList'); if(el.style.display==='none'){ el.style.display='block'; el.innerHTML=''; (state.archived||[]).slice().reverse().forEach(t=>{ const wrap=document.createElement('div'); wrap.className='item done'; wrap.innerHTML = '<div class="txt">âœ“ '+t.text+'</div><span class="timer">'+fmtHMS(t.elapsed||0)+'</span>'; el.appendChild(wrap); (t.subtasks||[]).forEach(s=>{ const r=document.createElement('div'); r.className='item done'; r.style.marginLeft='36px'; r.innerHTML = '<div class="txt">â†³ '+s.text+'</div><span class="timer">'+fmtHMS(s.elapsed||0)+'</span>'; el.appendChild(r); }); }); } else { el.style.display='none'; }});

  on(exportBtn,'click',()=>{ const data={version:'v6.0',exportedAt:new Date().toISOString(),tasks:state.tasks,archived:state.archived,settings:state.settings,best:state.best}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='study_tasks_backup.json'; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url);a.remove()},200)});
  on(importFile,'change',()=>{ const f=importFile.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const data=JSON.parse(fr.result);
        if(Array.isArray(data.tasks)) state.tasks=data.tasks; else if(data.tasks && typeof data.tasks==='object') state.tasks=Object.values(data.tasks);
        if(Array.isArray(data.archived)) state.archived=data.archived;
        if(data.settings) state.settings=Object.assign({},state.settings,data.settings);
        if(data.best) state.best=data.best;
        (state.tasks||[]).forEach(ensureShapeTask); (state.archived||[]).forEach(ensureShapeTask);
        soundSel.value=state.settings.custom?'custom':(state.settings.sound||'ding');
        volEl.value=typeof state.settings.vol==='number'?state.settings.vol:1; volLabel.textContent=Math.round(+volEl.value*100)+'%';
        playChk.checked=!!state.settings.play; beatChk.checked=!!state.settings.beatChime; ttbToggle.checked=!!state.settings.showTTB; applyFontVars();
        simpleToggle.checked=!!state.settings.simple; document.body.classList.toggle('simple', !!state.settings.simple);
        compactToggle.checked=!!state.settings.compact; document.body.classList.toggle('compact', !!state.settings.compact);
        save(); saveArchive(); saveSettings(); saveBest(); render(); }catch(e){ showErr('Import failed: '+e.message) } }; fr.readAsText(f) });

  on(testBtn,'click',()=>{ playJingle(); });

  setInterval(()=>{ function walk(arr){ (arr||[]).forEach(t=>{ if(t.running) updateTimer(t); updateGoalDisplays(t); walk(t.subtasks||[]); }); } walk(state.tasks); updateProgress(); drawHeatmapStreakBest(); if(focusRef) updateFocusClock(); },1000);

  // focus input at start
  inputEl.focus();
  render();
})();
</script>
</body>
</html>
