<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Study Tasks + Timers (v5.5)</title>
<style>
:root{--bg:#0b1225;--card:#111827;--text:#e5e7eb;--mut:#9aa3b2;--acc:#22c55e;--danger:#ef4444;--bd:rgba(148,163,184,.2);--ovl:rgba(2,6,23,.7)}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;background:linear-gradient(135deg,#0b1225,#121a33);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1040px;margin:24px auto;padding:16px}.card{background:rgba(17,24,39,.88);border:1px solid var(--bd);backdrop-filter:blur(6px);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.h{display:flex;align-items:center;gap:10px;flex-wrap:wrap}.h h1{margin:0;font-size:20px}.sp{flex:1}
.pill{font-size:12px;background:rgba(148,163,184,.15);padding:4px 8px;border-radius:999px;border:1px solid var(--bd)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
input[type="text"]{flex:1;min-width:220px;padding:10px 12px;border-radius:12px;border:1px solid var(--bd);background:#0b1225;color:var(--text)}
button{cursor:pointer;border:0;border-radius:12px;padding:9px 12px;font-weight:600}
.btn{background:transparent;border:1px solid var(--bd);color:var(--text)}.pri{background:var(--acc);color:#052e16}
.dang{background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(239,68,68,.35)}
.list{margin-top:12px}.mut{color:var(--mut)}
.item{display:grid;grid-template-columns:auto 1fr auto auto;gap:10px;align-items:center;background:rgba(2,6,23,.5);border:1px solid rgba(148,163,184,.12);padding:9px 10px;border-radius:12px;margin:8px 0}
.left{display:flex;gap:8px;align-items:center}.txt{padding:2px 4px;border-radius:6px}
.txt[contenteditable="true"]{outline:2px solid rgba(148,163,184,.35);background:#0b1225}.done .txt{text-decoration:line-through;color:#9ca3af}
.tm{font:600 12px ui-monospace,Menlo,monospace;background:rgba(148,163,184,.12);padding:3px 7px;border-radius:9px}
.mini{font-size:12px;color:var(--mut)}.link{text-decoration:underline dotted;cursor:pointer}
.pb{height:7px;background:rgba(148,163,184,.18);border-radius:999px;overflow:hidden;border:1px solid var(--bd);min-width:140px}.pb>div{height:100%;width:0;background:linear-gradient(90deg,#22c55e,#16a34a)}
.pb.over>div{background:linear-gradient(90deg,#ef4444,#dc2626)}
.subwrap{grid-column:1/-1;margin-top:6px;border-top:1px dashed rgba(148,163,184,.25);padding-top:6px}
.overlay{position:fixed;inset:0;background:var(--ovl);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal{max-width:720px;width:100%;background:#0e162c;border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.center{text-align:center}.clock{font:700 48px/1 ui-monospace,Menlo,monospace;margin:6px 0 10px}
</style></head><body>
<div class="wrap"><div class="card">
  <div class="h"><h1>Study Tasks + Timers <span class="mut">(v5.5)</span></h1><div class="sp"></div>
    <span id="today" class="pill">Today 00:00</span>
    <span id="best" class="pill">üèÜ Best 00:00</span>
  </div>
  <div class="row">
    <input id="taskIn" placeholder="New task‚Ä¶ e.g., Pathoma Ch. 1"><button id="add" class="pri">Add Task</button>
    <button id="clr" class="btn">Clear Completed</button><button id="arc" class="btn">Archive Completed</button>
    <button id="togArc" class="btn">Open Archive</button><button id="ex" class="btn">Export JSON</button>
    <label class="btn" for="im">Import JSON</label><input id="im" type="file" accept="application/json" style="display:none">
  </div>
  <div class="row">
    <span class="mut">Jingle</span>
    <select id="snd" class="btn"><option value="ding">Ding</option><option value="chime">Chime</option><option value="pop">Pop</option><option value="custom">Custom</option></select>
    <input id="sndFile" type="file" accept="audio/*">
    <span class="mut">Vol</span><input id="vol" type="range" min="0" max="1" step="0.01" value="1" style="width:120px"><span id="vLab" class="mut">100%</span>
    <label class="mut"><input id="play" type="checkbox" checked> Play on complete</label>
    <label class="mut"><input id="beat" type="checkbox" checked> Chime when beating TTB</label>
  </div>
  <div id="list" class="list"></div><div id="arch" class="list" style="display:none"></div>
</div></div>

<div id="ovl" class="overlay"><div class="modal"><div class="center">
  <h3 id="fTitle">Focus</h3><div id="fClock" class="clock">00:00:00</div>
  <div id="fLines" class="mut" style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap"></div>
  <div class="row" style="justify-content:center">
    <button id="fStart" class="pri">Start</button><button id="fPause" class="btn">Pause</button>
    <button id="fReset" class="dang">Reset</button><button id="fDone" class="btn">Mark Done</button>
    <button id="fClose" class="btn">Close</button>
  </div>
</div></div></div>

<script>
(()=>{
const $=id=>document.getElementById(id), on=(e,t,f)=>e.addEventListener(t,f), pad=n=>String(n).padStart(2,'0');
const fmtHMS=ms=>{ms=Math.max(0,ms|0);const s=(ms/1e3|0);return pad(s/3600|0)+':'+pad((s%3600)/60|0)+':'+pad(s%60)};
const fmtHM=ms=>{ms=Math.max(0,ms/6e4|0);return pad(ms/60|0)+':'+pad(ms%60)};
const newId=()=> 'id-'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const LS_T='tasks_v55', LS_A='arch_v55', LS_S='set_v55', LS_B='best_v55';
let state={tasks:js(LS_T,[]), arch:js(LS_A,[]), set:Object.assign({snd:'ding',cust:null,vol:1,play:true,beat:true}, js(LS_S,{})), best:js(LS_B,{m:0,date:null})};
function sv(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}
function js(k,f){try{let v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}}
const list=$('list'), arcList=$('arch');

// audio
const snd=$('snd'), sndFile=$('sndFile'), vol=$('vol'), vLab=$('vLab'), play=$('play'), beat=$('beat');
snd.value=state.set.cust?'custom':(state.set.snd||'ding'); vol.value=+state.set.vol||1; vLab.textContent=(vol.value*100|0)+'%'; play.checked=!!state.set.play; beat.checked=!!state.set.beat;
on(snd,'change',()=>{state.set.snd=snd.value; sv(LS_S,state.set)});
on(sndFile,'change',()=>{const f=sndFile.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{state.set.cust=fr.result; snd.value='custom'; state.set.snd='custom'; sv(LS_S,state.set)}; fr.readAsDataURL(f)});
on(vol,'input',()=>{state.set.vol=+vol.value; vLab.textContent=(vol.value*100|0)+'%'; sv(LS_S,state.set)});
on(play,'change',()=>{state.set.play=play.checked; sv(LS_S,state.set)});
on(beat,'change',()=>{state.set.beat=beat.checked; sv(LS_S,state.set)});

function bell(){ if(!state.set.play) return; const v=+state.set.vol||1;
  if(state.set.cust && snd.value==='custom'){ const a=new Audio(state.set.cust); a.volume=v; a.play().catch(()=>{}); return; }
  const ctx=new (window.AudioContext||window.webkitAudioContext)(), now=ctx.currentTime;
  const B=(f,d,vol,del,type='sine')=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type=type;o.frequency.value=f;g.gain.setValueAtTime(.0001,now+del);g.gain.exponentialRampToValueAtTime(vol,now+del+.02);g.gain.exponentialRampToValueAtTime(.0001,now+del+d);o.connect(g).connect(ctx.destination);o.start(now+del);o.stop(now+del+d+.02)};
  const m=snd.value||'ding'; if(m==='ding'){B(880,.1,.7,0);B(1175,.12,.6,.12)} else if(m==='chime'){B(659,.25,.8,0);B(523,.35,.6,.02);B(784,.4,.5,.03)} else {B(300,.09,.4,0,'square')}
}
function blip(){ if(!state.set.beat) return; const ctx=new (window.AudioContext||window.webkitAudioContext)(), n=ctx.currentTime;
  const t=(f,d,vol,del)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(.0001,n+del);g.gain.exponentialRampToValueAtTime(vol,n+del+.02);g.gain.exponentialRampToValueAtTime(.0001,n+del+d);o.connect(g).connect(ctx.destination);o.start(n+del);o.stop(n+del+d+.02)}; t(988,.08,.5,0); t(1319,.1,.5,.1);
}

const nowMs=() => Date.now();
const curMs=t => t.running ? t.elapsed + (nowMs()-(t.startedAt||nowMs())) : t.elapsed;

function render(){
  list.innerHTML=''; if(!state.tasks.length){const d=document.createElement('div'); d.className='mut'; d.textContent='No tasks yet ‚Äî add one above.'; list.appendChild(d);}
  state.tasks.slice().sort((a,b)=> (a.order-b.order)||(a.created>b.created?1:-1)).forEach((t,i)=> list.appendChild(rowTask(t,i)));
  drawBest();
}

function editable(div,obj){ const start=()=>{div.setAttribute('contenteditable','true'); div.focus(); let r=document.createRange(); r.selectNodeContents(div); r.collapse(false); let s=window.getSelection(); s.removeAllRanges(); s.addRange(r)};
  const stop=(save)=>{ if(div.getAttribute('contenteditable')!=='true') return; div.removeAttribute('contenteditable'); if(save){ const v=div.textContent.trim(); if(v){obj.text=v; sv(LS_T,state.tasks);} else div.textContent=obj.text;} else div.textContent=obj.text; };
  on(div,'click',start); on(div,'keydown',e=>{if(e.key==='Enter'){e.preventDefault();stop(true)} if(e.key==='Escape'){e.preventDefault();stop(false)}}); on(div,'blur',()=>stop(true));
}

function rowTask(t,idx){
  if(!Array.isArray(t.sub)) t.sub=[]; if(!t.sessions) t.sessions=[]; if(t.ttb_ms===undefined) t.ttb_ms=null; if(t.deadline_ts===undefined) t.deadline_ts=null;
  const r=doc('div','item'+(t.done?' done':''));
  const left=doc('div','left');
  const cb=doc('input'); cb.type='checkbox'; cb.checked=t.done; on(cb,'change',()=>{ if(cb.checked){ if(t.running) pause(t); t.done=true; t.completed_at=new Date().toISOString(); if(t.ttb_ms && curMs(t)<=t.ttb_ms) blip(); bell(); } else { t.done=false; t.completed_at=null;} sv(LS_T,state.tasks); render(); });
  const txt=doc('div','txt'); txt.textContent=t.text; editable(txt,t); left.appendChild(cb); left.appendChild(txt);
  const tm=doc('span','tm'); tm.id='tm-'+t.id; tm.textContent=fmtHMS(curMs(t));
  const ctr=doc('div');
  const sbtn=btn(t.running?'Pause':'Start'); on(sbtn,'click',()=>{ if(t.running) pause(t); else start(t); tm.textContent=fmtHMS(curMs(t)); sbtn.textContent=t.running?'Pause':'Start'; sv(LS_T,state.tasks) });
  const rs=btn('Reset'); on(rs,'click',()=>{ if(confirm('Reset timer?')){ t.elapsed=0; t.sessions=[]; if(t.running) t.startedAt=nowMs(); tm.textContent=fmtHMS(curMs(t)); sv(LS_T,state.tasks); render(); } });
  const up=btn('‚Üë'), dn=btn('‚Üì'); on(up,'click',()=>move(idx,Math.max(0,idx-1))); on(dn,'click',()=>move(idx,Math.min(state.tasks.length-1,idx+1)));
  const foc=btn('Focus','pri'); on(foc,'click',()=>openFocus(t));
  const del=btn('Delete','dang'); on(del,'click',()=>{ if(confirm('Delete task?')){ if(t.running) pause(t); state.tasks=state.tasks.filter(x=>x.id!==t.id); reindex(); sv(LS_T,state.tasks); render(); }});
  ctr.append(sbtn,rs,up,dn,foc,del);
  // goals line
  const g=doc('div'); g.style.gridColumn='1/-1';
  const ttb=doc('span','mini link'); ttb.id='ttb-'+t.id; ttb.title='Click to set/clear TTB (minutes)'; on(ttb,'click',()=>setTTB(t,t.id)); const bar=doc('div','pb'); bar.id='bar-'+t.id; bar.appendChild(doc('div'));
  const ddl=doc('span','mini link'); ddl.id='dl-'+t.id; ddl.title='Click to set deadline minutes from now (blank=clear)'; on(ddl,'click',()=>setDL(t,t.id));
  g.append(ttb,bar,ddl);
  // subtasks
  const subwrap=doc('div','subwrap'), sh=doc('div'), sin=doc('input'); sin.placeholder='Add subtask‚Ä¶'; const sadd=btn('Add Subtask'); on(sadd,'click',()=>{ const v=(sin.value||'').trim(); if(!v) return; t.sub.push(newSub(v)); sv(LS_T,state.tasks); render(); }); on(sin,'keydown',e=>{if(e.key==='Enter'){e.preventDefault();sadd.click()}}); sh.append(sin,sadd);
  const sl=doc('div'); t.sub.forEach((st,i)=> sl.appendChild(rowSub(t,st,i))); subwrap.append(sh,sl);

  r.append(left,tm,ctr,g,subwrap);
  updGoals(t,t.id);
  if(t.sub.length){ const all=t.sub.every(x=>x.done); if(all && !t.done){ t.done=true; cb.checked=true; sv(LS_T,state.tasks); } if(!all && t.done){ t.done=false; cb.checked=false; sv(LS_T,state.tasks); } }
  return r;
}
function rowSub(p,st,idx){
  if(!st.sessions) st.sessions=[]; if(st.ttb_ms===undefined) st.ttb_ms=null; if(st.deadline_ts===undefined) st.deadline_ts=null;
  const key=p.id+'__'+st.id, r=doc('div','item'+(st.done?' done':'')), left=doc('div','left');
  const cb=doc('input'); cb.type='checkbox'; cb.checked=st.done; on(cb,'change',()=>{ if(cb.checked){ if(st.running) pause(st); st.done=true; st.completed_at=new Date().toISOString(); if(st.ttb_ms && curMs(st)<=st.ttb_ms) blip(); bell(); } else { st.done=false; st.completed_at=null;} sv(LS_T,state.tasks); render(); });
  const txt=doc('div','txt'); txt.textContent=st.text; editable(txt,st); left.append(cb,txt);
  const tm=doc('span','tm'); tm.id='tm-'+key; tm.textContent=fmtHMS(curMs(st));
  const ctr=doc('div'); const sbtn=btn(st.running?'Pause':'Start'); on(sbtn,'click',()=>{ if(st.running) pause(st); else start(st); tm.textContent=fmtHMS(curMs(st)); sbtn.textContent=st.running?'Pause':'Start'; sv(LS_T,state.tasks)});
  const rs=btn('Reset'); on(rs,'click',()=>{ if(confirm('Reset subtask timer?')){ st.elapsed=0; st.sessions=[]; if(st.running) st.startedAt=nowMs(); tm.textContent=fmtHMS(curMs(st)); sv(LS_T,state.tasks); render(); } });
  const up=btn('‚Üë'), dn=btn('‚Üì'); on(up,'click',()=>moveSub(p,idx,Math.max(0,idx-1))); on(dn,'click',()=>moveSub(p,idx,Math.min(p.sub.length-1,idx+1)));
  const foc=btn('Focus','pri'); on(foc,'click',()=>openFocus(st,p));
  const del=btn('Delete','dang'); on(del,'click',()=>{ if(confirm('Delete subtask?')){ if(st.running) pause(st); p.sub=p.sub.filter(x=>x.id!==st.id); sv(LS_T,state.tasks); render(); }});
  ctr.append(sbtn,rs,up,dn,foc,del);
  const g=doc('div'); g.style.gridColumn='1/-1';
  const ttb=doc('span','mini link'); ttb.id='ttb-'+key; on(ttb,'click',()=>setTTB(st,key)); const bar=doc('div','pb'); bar.id='bar-'+key; bar.appendChild(doc('div'));
  const ddl=doc('span','mini link'); ddl.id='dl-'+key; on(ddl,'click',()=>setDL(st,key)); g.append(ttb,bar,ddl);
  r.append(left,tm,ctr,g); updGoals(st,key); return r;
}

function setTTB(obj,key){ const cur=obj.ttb_ms?Math.round(obj.ttb_ms/6e4):''; const v=prompt('TTB minutes (blank to clear):', cur); if(v===null) return; const m=parseInt(v,10); obj.ttb_ms=(isFinite(m)&&m>0)? m*6e4 : null; sv(LS_T,state.tasks); updGoals(obj,key); }
function setDL(obj,key){ const v=prompt('Deadline minutes from now (blank to clear):',''); if(v===null) return; const m=parseInt(v,10); obj.deadline_ts=(isFinite(m)&&m>0)? (nowMs()+m*6e4):null; sv(LS_T,state.tasks); updGoals(obj,key); }
function updGoals(obj,key){ const t=$('ttb-'+key), b=$('bar-'+key), d=$('dl-'+key); if(t&&b){ if(obj.ttb_ms){ const ms=curMs(obj), rem=obj.ttb_ms-ms, pct=Math.max(0,Math.min(100, Math.round(ms/obj.ttb_ms*100))); b.firstChild.style.width=pct+'%'; b.classList.toggle('over', rem<0); t.textContent = 'TTB: '+Math.round(obj.ttb_ms/6e4)+'m ‚Ä¢ '+(rem>=0?('remaining '+fmtHMS(rem)):('over by '+fmtHMS(-rem))); } else { t.textContent='TTB: ‚Äî'; b.firstChild.style.width='0%'; b.classList.remove('over'); } } if(d){ if(obj.deadline_ts){ const diff=obj.deadline_ts-nowMs(); d.textContent='Deadline: '+(diff>=0?('‚è≥ '+fmtHMS(diff)+' left'):('‚è∞ past by '+fmtHMS(-diff))); d.style.color=diff<0?'#fecaca':''; } else { d.textContent='Deadline: ‚Äî'; d.style.color=''; } } }

function btn(t,cls='btn'){ const b=document.createElement('button'); b.className=cls; b.textContent=t; return b }
function doc(tag,cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e }
function newSub(text){ return {id:newId(),text,done:false,elapsed:0,running:false,startedAt:null,created:new Date().toISOString(),order:0,sessions:[],ttb_ms:null,deadline_ts:null,completed_at:null} }

function move(from,to){ if(from===to) return; const arr=state.tasks.slice().sort((a,b)=>(a.order-b.order)||(a.created>b.created?1:-1)); const it=arr.splice(from,1)[0]; arr.splice(to,0,it); arr.forEach((t,i)=>t.order=i); state.tasks=arr; sv(LS_T,arr); render(); }
function reindex(){ state.tasks.forEach((t,i)=>t.order=i) }
function moveSub(p,from,to){ if(from===to) return; const a=p.sub.slice(); const it=a.splice(from,1)[0]; a.splice(to,0,it); p.sub=a; sv(LS_T,state.tasks); render(); }

function start(t){ // pause all others
  state.tasks.forEach(x=>{ if(x.running && x!==t) pause(x); (x.sub||[]).forEach(s=>{ if(s.running && s!==t) pause(s); }); });
  if(t.running) return; t.running=true; t.startedAt=nowMs(); (t.sessions||(t.sessions=[])).push({start:t.startedAt,end:null});
}
function pause(t){ if(!t.running) return; t.elapsed += nowMs()-(t.startedAt||nowMs()); t.running=false; const last=t.sessions&&t.sessions.length?t.sessions[t.sessions.length-1]:null; if(last&&last.end==null) last.end=nowMs(); t.startedAt=null; }

// add/clear/archive
on($('add'),'click',()=>{ const v=($('taskIn').value||'').trim(); if(!v) return; state.tasks.push({id:newId(),text:v,done:false,elapsed:0,running:false,startedAt:null,created:new Date().toISOString(),order:state.tasks.length,sessions:[],ttb_ms:null,deadline_ts:null,completed_at:null,sub:[]}); sv(LS_T,state.tasks); $('taskIn').value=''; render(); });
on($('taskIn'),'keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('add').click(); }});
on($('clr'),'click',()=>{ state.tasks=state.tasks.filter(t=>!t.done); reindex(); sv(LS_T,state.tasks); render(); });
on($('arc'),'click',()=>{ const moved=[]; state.tasks=state.tasks.filter(t=>{ if(t.done){ moved.push(t); return false } return true}); if(moved.length){ state.arch=(state.arch||[]).concat(moved); sv(LS_T,state.tasks); sv(LS_A,state.arch); render(); }});
on($('togArc'),'click',()=>{ const el=$('arch'); if(el.style.display==='none'){ el.style.display='block'; el.innerHTML=''; (state.arch||[]).slice().reverse().forEach(t=>{ const r=doc('div','item done'); r.innerHTML='<div class=\"txt\">‚úì '+t.text+'</div><span class=\"tm\">'+fmtHMS(t.elapsed||0)+'</span>'; el.appendChild(r); }); } else el.style.display='none'; });

// export/import
on($('ex'),'click',()=>{ const data={version:'v5.5',exportedAt:new Date().toISOString(),tasks:state.tasks,arch:state.arch,set:state.set,best:state.best}; const blob=new Blob([JSON.stringify(data)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='study_tasks_backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),200); });
on($('im'),'change',()=>{ const f=$('im').files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const d=JSON.parse(fr.result); if(Array.isArray(d.tasks)) state.tasks=d.tasks.map(t=>({sub:[],sessions:[],ttb_ms:null,deadline_ts:null,completed_at:null,...t, sub:(t.sub||t.subtasks||[]).map(s=>({sessions:[],ttb_ms:null,deadline_ts:null,completed_at:null,...s}))})); if(Array.isArray(d.arch)) state.arch=d.arch; if(d.set) state.set=Object.assign(state.set,d.set); if(d.best) state.best=d.best; snd.value=state.set.cust?'custom':(state.set.snd||'ding'); vol.value=+state.set.vol||1; vLab.textContent=(vol.value*100|0)+'%'; play.checked=!!state.set.play; beat.checked=!!state.set.beat; sv(LS_T,state.tasks); sv(LS_A,state.arch); sv(LS_S,state.set); sv(LS_B,state.best); render(); }catch(e){ alert('Import failed: '+e.message) } }; fr.readAsText(f) });

// focus
let F=null; const ovl=$('ovl'), fTitle=$('fTitle'), fClock=$('fClock'), fLines=$('fLines');
function openFocus(obj,parent){ F={obj}; ovl.style.display='flex'; fTitle.textContent='Focus: '+obj.text; updF(); }
on($('fStart'),'click',()=>{ if(!F) return; start(F.obj); sv(LS_T,state.tasks); });
on($('fPause'),'click',()=>{ if(!F) return; pause(F.obj); sv(LS_T,state.tasks); });
on($('fReset'),'click',()=>{ if(!F) return; if(confirm('Reset timer?')){ F.obj.elapsed=0; F.obj.sessions=[]; if(F.obj.running) F.obj.startedAt=nowMs(); sv(LS_T,state.tasks); }});
on($('fDone'),'click',()=>{ if(!F) return; F.obj.done=true; pause(F.obj); if(F.obj.ttb_ms && curMs(F.obj)<=F.obj.ttb_ms) blip(); bell(); F.obj.completed_at=new Date().toISOString(); sv(LS_T,state.tasks); render(); });
on($('fClose'),'click',()=>{ ovl.style.display='none'; F=null; });
on(document,'keydown',e=>{ if(ovl.style.display==='flex'){ if(e.key==='Escape'){ ovl.style.display='none'; F=null; } else if(e.key===' '){ e.preventDefault(); if(!F) return; F.obj.running?pause(F.obj):start(F.obj); sv(LS_T,state.tasks); } else if(e.key.toLowerCase()==='r'){ e.preventDefault(); if(!F) return; F.obj.elapsed=0; F.obj.sessions=[]; if(F.obj.running) F.obj.startedAt=nowMs(); sv(LS_T,state.tasks); } }});
function updF(){ if(!F) return; fClock.textContent=fmtHMS(curMs(F.obj)); fLines.innerHTML=''; if(F.obj.ttb_ms){ const rem=F.obj.ttb_ms-curMs(F.obj); addPill(rem>=0?('TTB '+fmtHMS(rem)+' left'):('TTB over '+fmtHMS(-rem))); } if(F.obj.deadline_ts){ const diff=F.obj.deadline_ts-nowMs(); addPill(diff>=0?('Deadline '+fmtHMS(diff)+' left'):('Deadline past '+fmtHMS(-diff))); } }
function addPill(txt){ const s=document.createElement('span'); s.className='pill'; s.textContent=txt; fLines.appendChild(s) }

// best day scoreboard (minutes across tasks+subs by calendar day)
function drawBest(){
  const map={};
  function addSpan(a,b){ if(!(a&&b)&&b<=a) return; let st=a; while(st<b){ const e=new Date(st); e.setHours(23,59,59,999); const end=Math.min(b,e.getTime()); const k=new Date(st).toISOString().slice(0,10); map[k]=(map[k]||0)+(end-st); st=end+1; } }
  const all=[...state.tasks,...state.arch]; all.forEach(t=>{ (t.sessions||[]).forEach(s=> addSpan(s.start, s.end||nowMs())); (t.sub||[]).forEach(su=> (su.sessions||[]).forEach(s=> addSpan(s.start, s.end||nowMs())) ); });
  Object.keys(map).forEach(k=> map[k]=(map[k]/6e4)|0);
  const todayK=new Date().toISOString().slice(0,10), todayM=map[todayK]||0; $('today').textContent='Today '+fmtHM(todayM*6e4);
  if(todayM>(state.best.m||0)) { state.best={m:todayM,date:todayK}; sv(LS_B,state.best); }
  let best=state.best; for(const [d,m] of Object.entries(map)){ if(m>(best.m||0)) best={m,date:d}; }
  $('best').textContent='üèÜ Best '+fmtHM((best.m||0)*6e4)+' on '+(best.date||todayK);
}

setInterval(()=>{
  state.tasks.forEach(t=>{ if(t.running){ const el=$('tm-'+t.id); if(el) el.textContent=fmtHMS(curMs(t)); } updGoals(t,t.id); (t.sub||[]).forEach(s=>{ if(s.running){ const el=$('tm-'+t.id+'__'+s.id); if(el) el.textContent=fmtHMS(curMs(s)); } updGoals(s,t.id+'__'+s.id); }); });
  drawBest(); if(ovl.style.display==='flex') updF();
},1000);

render();

// helpers
function moveSub(p,from,to){ if(from===to) return; const a=p.sub.slice(); const it=a.splice(from,1)[0]; a.splice(to,0,it); p.sub=a; sv(LS_T,state.tasks); render(); }
})();</script>
</body></html>
